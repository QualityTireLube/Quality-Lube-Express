<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Quality Lube Express</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
      body {
        background-color: #f5f5f5;
        font-family: "Roboto", "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      .l-header {
        background: #000;
        color: #fff;
        padding: 10px 0;
      }
      .l-subheader-h {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }
      .admin-brand {
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        text-decoration: none;
      }
      .dashboard-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      }
      
      /* Override Bootstrap conflicts */
      a { text-decoration: none; }
      
      /* Tab Navigation */
      .nav-tabs .nav-link {
        color: #666;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        font-weight: 500;
      }
      .nav-tabs .nav-link:hover {
        border-color: #ddd;
        color: #333;
      }
      .nav-tabs .nav-link.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
        background: transparent;
      }
      
      /* Submission Cards */
      .submission-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        background: #fff;
        transition: all 0.2s ease;
      }
      .submission-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .submission-card.unread {
        border-left: 4px solid #0066cc;
        background: #f8faff;
      }
      .submission-card.read {
        border-left: 4px solid #28a745;
      }
      .submission-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      .submission-meta {
        font-size: 12px;
        color: #888;
      }
      .submission-type {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .submission-type.contact { background: #e3f2fd; color: #1976d2; }
      .submission-type.appointment { background: #fff3e0; color: #f57c00; }
      .submission-type.careers { background: #ede7f6; color: #7b1fa2; }
      .submission-type.self_check { background: #e8f5e9; color: #388e3c; }
      .submission-type.lead_capture_start { background: #fce4ec; color: #c2185b; }

      /* Inspection Results Styling */
      .inspection-results {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
      }
      .inspection-results-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
        color: #495057;
      }
      .inspection-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 13px;
      }
      .inspection-item:last-child {
        border-bottom: none;
      }
      .inspection-icon {
        width: 20px;
        text-align: center;
        flex-shrink: 0;
      }
      .inspection-icon.good { color: #28a745; }
      .inspection-icon.warning { color: #ffc107; }
      .inspection-icon.bad { color: #dc3545; }
      .inspection-label {
        flex: 1;
        color: #495057;
      }
      .inspection-notes {
        font-size: 12px;
        color: #6c757d;
        margin-left: 28px;
        font-style: italic;
      }
      .inspection-extra {
        font-size: 12px;
        color: #6c757d;
        margin-left: 28px;
        background: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        margin-top: 4px;
      }
      .inspection-summary {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        font-size: 13px;
      }
      .inspection-summary-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      /* Group Headers */
      .group-header {
        padding: 12px 15px;
        margin: 20px 0 10px 0;
        font-weight: 600;
        border-radius: 6px;
      }
      .group-header:first-child {
        margin-top: 0;
      }
      .date-header {
        background: #e3f2fd;
        color: #1565c0;
        font-size: 16px;
      }
      .type-header {
        background: #f3e5f5;
        color: #7b1fa2;
        font-size: 16px;
      }
      .type-subheader {
        background: #f5f5f5;
        color: #666;
        font-size: 14px;
        margin-left: 20px;
        margin-right: 0;
      }
      
      .submission-contact {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .submission-contact-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }
      .submission-contact-item i {
        color: #666;
        width: 16px;
      }
      .submission-contact-item a {
        color: #0066cc;
        text-decoration: none;
      }
      .submission-contact-item a:hover {
        text-decoration: underline;
      }
      
      .submission-message {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      
      .submission-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      
      /* Filter Bar */
      .filter-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
      }
      .filter-bar select, .filter-bar input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      /* Stats Bar */
      .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .stat-item {
        background: #f5f5f5;
        padding: 15px 25px;
        border-radius: 8px;
        text-align: center;
        min-width: 100px;
      }
      .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #0066cc;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }
      
      /* Live indicator */
      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #e8f5e9;
        border-radius: 20px;
        font-size: 12px;
        color: #388e3c;
      }
      .live-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      /* Quick Reply Modal */
      .quick-reply-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }
      .quick-reply-btn {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        text-align: left;
        font-size: 13px;
        transition: all 0.2s;
      }
      .quick-reply-btn:hover {
        border-color: #0066cc;
        background: #fff;
      }
      .quick-reply-btn i {
        margin-right: 8px;
        color: #0066cc;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ddd;
      }
      
      /* Form Switch Toggles */
      .form-check.form-switch {
        padding-left: 2.5em;
        min-height: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .form-check.form-switch .form-check-input {
        width: 2em;
        height: 1em;
        margin-left: -2.5em;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%280, 0, 0, 0.25%29'/%3e%3c/svg%3e");
        background-position: left center;
        border-radius: 2em;
        transition: background-position .15s ease-in-out;
        cursor: pointer;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
        appearance: none;
        -webkit-appearance: none;
      }
      .form-check.form-switch .form-check-input:checked {
        background-position: right center;
        background-color: #0d6efd;
        border-color: #0d6efd;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
      }
      .form-check.form-switch .form-check-input:focus {
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .form-check-label {
        cursor: pointer;
      }
      
      @media (max-width: 768px) {
        .filter-bar { flex-direction: column; align-items: stretch; }
        .stats-bar { justify-content: center; }
        .submission-header { flex-direction: column; gap: 10px; }
        .quick-reply-options { grid-template-columns: 1fr; }
        .visual-pricing-columns { flex-direction: column; }
      }

      /* ==================== VISUAL PAGE BUILDER STYLES ==================== */
      /* Matches the original pricing page layout at qualitytirelube.com/pricing */
      
      .page-builder-container {
        background: #e8e8e8;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 25px rgba(0,0,0,0.15);
      }
      
      /* Toolbar */
      .builder-toolbar {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        padding: 12px 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        border-bottom: 2px solid #1a252f;
      }
      
      .builder-toolbar .btn {
        border-radius: 6px;
        font-size: 0.85em;
        padding: 8px 14px;
      }
      
      .builder-toolbar .btn-tool {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
      }
      
      .builder-toolbar .btn-tool:hover {
        background: rgba(255,255,255,0.2);
        color: white;
      }
      
      .builder-toolbar .btn-tool.active {
        background: #3498db;
        border-color: #3498db;
      }
      
      .toolbar-divider {
        width: 1px;
        height: 30px;
        background: rgba(255,255,255,0.2);
        margin: 0 10px;
      }
      
      /* ==================== SLEEK MODERN PAGE BUILDER ==================== */
      
      /* Canvas - Clean background matching original */
      .builder-canvas {
        background-image: url('../assets/img/pricing-welcome-bg-cl-01.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        padding: 30px 20px 40px;
        min-height: 600px;
        position: relative;
      }
      
      /* Page Header - Elegant centered text */
      .builder-page-header {
        text-align: center;
        padding: 15px 20px 25px;
        margin-bottom: 25px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      
      .builder-page-header:hover {
        background: rgba(255,255,255,0.08);
      }
      
      .builder-page-header h2 {
        font-size: 1.1em;
        font-weight: 400;
        font-style: italic;
        margin-bottom: 0;
        color: #000;
        letter-spacing: 2px;
      }
      
      .builder-page-header h1 {
        font-size: 2.4em;
        font-weight: 300;
        color: #000;
        letter-spacing: 1px;
        margin-top: 5px;
      }
      
      /* Seamless editable text - looks like regular text */
      .editable-text {
        background: transparent;
        border: none;
        color: inherit;
        font: inherit;
        text-align: inherit;
        width: 100%;
        outline: none;
        cursor: text;
        transition: background 0.2s;
      }
      
      .editable-text:hover {
        background: rgba(255,255,255,0.15);
      }
      
      .editable-text:focus {
        background: rgba(255,255,255,0.25);
        outline: none;
      }
      
      .page-header-text {
        color: #000 !important;
      }
      
      /* Columns Container */
      .builder-columns {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: stretch;
      }
      
      /* Column Base - Clean card style */
      .builder-column {
        flex: 1;
        min-width: 280px;
        max-width: 350px;
        position: relative;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        transition: box-shadow 0.3s ease;
      }
      
      .builder-column:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      }
      
      /* Light Theme - Clean white like original OIL/TIRES */
      .builder-column.light-theme {
        background: #fff;
        color: #222;
      }
      
      .builder-column.light-theme .column-header {
        background: transparent;
        padding: 20px 15px 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .builder-column.light-theme .column-header .column-title {
        font-size: 1.4em;
        color: #222;
        font-weight: 600;
      }
      
      .builder-column.light-theme .column-content {
        background: #fff;
        color: #222;
        padding: 0 15px 15px;
      }
      
      .builder-column.light-theme input,
      .builder-column.light-theme .editable-text {
        color: #222 !important;
      }
      
      /* Dark Theme - TechNet background like BRAKES */
      .builder-column.dark-theme {
        background: url('../assets/img/pricing-technet-bg-cl-01.jpg') center/cover no-repeat;
        background-color: #1a1a1a;
        color: #fff;
      }
      
      .builder-column.dark-theme .column-header {
        background: transparent;
        padding: 20px 15px 15px;
        border-bottom: 1px solid rgba(255,255,255,0.25);
      }
      
      .builder-column.dark-theme .column-header .column-title {
        font-size: 1.4em;
        color: #fff;
        font-weight: 600;
      }
      
      .builder-column.dark-theme .column-content {
        background: transparent;
        color: #fff;
        padding: 0 15px 15px;
      }
      
      .builder-column.dark-theme input,
      .builder-column.dark-theme .editable-text {
        color: #fff !important;
      }
      
      /* Column Header */
      .column-header {
        text-align: center;
        position: relative;
      }
      
      .column-title {
        font-size: 1.3em;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      
      .column-title input {
        background: transparent;
        border: none;
        text-align: center;
        font: inherit;
        color: inherit;
        width: 100%;
        padding: 0;
      }
      
      .column-title input:focus {
        background: rgba(128,128,128,0.1);
        outline: none;
        border-radius: 4px;
      }
      
      .column-title input::placeholder {
        color: transparent;
      }
      
      /* Hidden controls - appear on hover */
      .column-controls {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .builder-column:hover .column-controls {
        opacity: 1;
      }
      
      .column-controls .btn {
        padding: 4px 8px;
        font-size: 0.7em;
        border-radius: 4px;
      }
      
      /* Column Content */
      .column-content {
        min-height: 100px;
      }
      
      /* Section - Clean grouping */
      .builder-section {
        margin-bottom: 20px;
        padding: 0;
        border: none;
        transition: background 0.2s;
        position: relative;
        border-radius: 4px;
      }
      
      .builder-section:hover {
        background: rgba(128,128,128,0.05);
      }
      
      .dark-theme .builder-section:hover {
        background: rgba(255,255,255,0.05);
      }
      
      /* Section Header - Clean line separator */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0 8px;
        border-bottom: 1px solid #ddd;
        cursor: default;
      }
      
      .light-theme .section-header {
        border-bottom-color: #ddd;
      }
      
      .dark-theme .section-header {
        border-bottom-color: rgba(255,255,255,0.2);
      }
      
      .section-name {
        font-weight: 700;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: inherit;
      }
      
      /* Section name input - invisible until focused */
      .section-name input {
        background: transparent;
        border: none;
        font: inherit;
        color: inherit;
        width: auto;
        min-width: 100px;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
      }
      
      .section-name input:hover {
        background: rgba(128,128,128,0.1);
      }
      
      .section-name input:focus {
        background: rgba(128,128,128,0.15);
        outline: none;
      }
      
      .section-name input::placeholder {
        color: rgba(128,128,128,0.4);
        font-weight: normal;
        font-style: italic;
      }
      
      .dark-theme .section-name input::placeholder {
        color: rgba(255,255,255,0.3);
      }
      
      .section-subtitle {
        font-size: 0.8em;
        color: #888;
        font-weight: normal;
      }
      
      .dark-theme .section-subtitle {
        color: rgba(255,255,255,0.6);
      }
      
      .section-subtitle input {
        background: transparent;
        border: none;
        font: inherit;
        color: inherit;
        width: 60px;
        text-align: right;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
      }
      
      .section-subtitle input:hover {
        background: rgba(128,128,128,0.1);
      }
      
      .section-subtitle input:focus {
        background: rgba(128,128,128,0.15);
        outline: none;
      }
      
      .section-subtitle input::placeholder {
        color: transparent;
      }
      
      /* Hidden section controls */
      .section-controls {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .builder-section:hover .section-controls {
        opacity: 1;
      }
      
      .section-controls .btn {
        padding: 2px 6px;
        font-size: 0.65em;
        border-radius: 3px;
      }
      
      /* Service Item Row - Clean and minimal */
      .builder-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 4px;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      
      .builder-item:last-child {
        border-bottom: none;
      }
      
      .builder-item:hover {
        background: rgba(0,0,0,0.03);
      }
      
      .dark-theme .builder-item {
        border-bottom-color: rgba(255,255,255,0.08);
      }
      
      .dark-theme .builder-item:hover {
        background: rgba(255,255,255,0.06);
      }
      
      /* Reorder buttons - very subtle */
      .item-reorder-btns {
        display: flex;
        flex-direction: column;
        gap: 1px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .builder-item:hover .item-reorder-btns {
        opacity: 0.6;
      }
      
      .builder-item:hover .item-reorder-btns:hover {
        opacity: 1;
      }
      
      .reorder-btn {
        background: transparent;
        border: none;
        border-radius: 2px;
        padding: 1px 4px;
        cursor: pointer;
        font-size: 0.6em;
        color: #999;
        transition: all 0.2s;
      }
      
      .reorder-btn:hover:not(.disabled) {
        background: #3498db;
        color: white;
      }
      
      .reorder-btn.disabled {
        opacity: 0.2;
        cursor: not-allowed;
      }
      
      .dark-theme .reorder-btn {
        color: rgba(255,255,255,0.5);
      }
      
      .dark-theme .reorder-btn:hover:not(.disabled) {
        background: #3498db;
        color: white;
      }
      
      /* Column reorder - minimal */
      .column-reorder-btns {
        display: flex;
        gap: 3px;
        margin-right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .column-header:hover .column-reorder-btns {
        opacity: 1;
      }
      
      .reorder-btn-horiz {
        background: transparent;
        border: 1px solid rgba(128,128,128,0.3);
        border-radius: 3px;
        padding: 3px 6px;
        cursor: pointer;
        font-size: 0.7em;
        color: inherit;
        opacity: 0.6;
        transition: all 0.2s;
      }
      
      .reorder-btn-horiz:hover:not(.disabled) {
        background: #3498db;
        color: white;
        border-color: #3498db;
        opacity: 1;
      }
      
      .reorder-btn-horiz.disabled {
        opacity: 0.2;
        cursor: not-allowed;
      }
      
      /* Section reorder - minimal */
      .section-reorder-btns {
        display: flex;
        flex-direction: column;
        gap: 1px;
        margin-right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .section-header:hover .section-reorder-btns {
        opacity: 1;
      }
      
      .item-drag-handle {
        display: none;
      }
      
      /* Item name - clean text look */
      .item-name {
        flex: 1;
        min-width: 0;
      }
      
      .item-name input {
        width: 100%;
        padding: 4px 6px;
        border: none;
        border-radius: 3px;
        font-size: 0.9em;
        background: transparent;
        color: inherit;
        transition: background 0.2s;
      }
      
      .item-name input:hover {
        background: rgba(128,128,128,0.08);
      }
      
      .item-name input:focus {
        background: rgba(128,128,128,0.12);
        outline: none;
      }
      
      .item-name input::placeholder {
        color: rgba(128,128,128,0.4);
        font-style: italic;
      }
      
      .dark-theme .item-name input::placeholder {
        color: rgba(255,255,255,0.3);
      }
      
      /* Item price - clean text look */
      .item-price {
        flex: 0 0 auto;
      }
      
      .item-price input {
        width: auto;
        min-width: 80px;
        padding: 4px 6px;
        border: none;
        border-radius: 3px;
        font-size: 0.9em;
        text-align: right;
        font-weight: 600;
        background: transparent;
        color: inherit;
        transition: background 0.2s;
      }
      
      .item-price input:hover {
        background: rgba(128,128,128,0.08);
      }
      
      .item-price input:focus {
        background: rgba(128,128,128,0.12);
        outline: none;
      }
      
      .item-price input::placeholder {
        color: rgba(128,128,128,0.4);
        font-weight: normal;
      }
      
      .dark-theme .item-price input::placeholder {
        color: rgba(255,255,255,0.3);
      }
      
      /* Item controls - hidden until hover */
      .item-controls {
        display: flex;
        gap: 3px;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .builder-item:hover .item-controls {
        opacity: 1;
      }
      
      .item-controls .btn {
        padding: 2px 5px;
        font-size: 0.65em;
        border-radius: 3px;
      }
      
      /* Add Buttons - Subtle and modern */
      .add-section-btn, .add-item-btn {
        width: 100%;
        padding: 8px 12px;
        border: 1px dashed rgba(128,128,128,0.3);
        background: transparent;
        border-radius: 4px;
        color: rgba(128,128,128,0.6);
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 10px;
        font-size: 0.8em;
      }
      
      .add-section-btn:hover, .add-item-btn:hover {
        border-color: #3498db;
        color: #3498db;
        background: rgba(52, 152, 219, 0.05);
      }
      
      .dark-theme .add-section-btn, .dark-theme .add-item-btn {
        border-color: rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.5);
      }
      
      .dark-theme .add-section-btn:hover, .dark-theme .add-item-btn:hover {
        border-color: #3498db;
        color: #3498db;
      }
      
      /* Column Footer - Footnotes and logo */
      .column-footer {
        padding: 15px 10px;
        text-align: center;
        font-size: 0.75em;
        color: #666;
        font-style: italic;
      }
      
      .dark-theme .column-footer {
        color: rgba(255,255,255,0.7);
        padding: 20px 10px;
      }
      
      .dark-theme .column-footer img {
        max-width: 140px;
        margin-top: 15px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      
      /* Add Column Button - Modern card style */
      .add-column-btn {
        min-width: 100px;
        min-height: 200px;
        border: 2px dashed rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        color: rgba(255,255,255,0.6);
      }
      
      .add-column-btn:hover {
        border-color: #3498db;
        background: rgba(255,255,255,0.15);
        color: #3498db;
      }
      
      .add-column-btn i {
        font-size: 1.5em;
        margin-bottom: 8px;
      }
      
      /* ==================== PREVIEW MODE ==================== */
      /* True to life - matches the actual pricing page exactly */
      
      .builder-canvas.preview-mode {
        padding: 30px 20px 40px;
      }
      
      /* Hide all editing controls in preview */
      .builder-canvas.preview-mode .column-controls,
      .builder-canvas.preview-mode .section-controls,
      .builder-canvas.preview-mode .item-controls,
      .builder-canvas.preview-mode .add-section-btn,
      .builder-canvas.preview-mode .add-item-btn,
      .builder-canvas.preview-mode .add-column-btn,
      .builder-canvas.preview-mode .item-drag-handle,
      .builder-canvas.preview-mode .item-reorder-btns,
      .builder-canvas.preview-mode .section-reorder-btns,
      .builder-canvas.preview-mode .column-reorder-btns {
        display: none !important;
      }
      
      /* Clean sections */
      .builder-canvas.preview-mode .builder-section {
        margin-bottom: 18px;
        padding: 0;
      }
      
      .builder-canvas.preview-mode .builder-section:hover {
        background: transparent;
      }
      
      /* Clean items - table row style */
      .builder-canvas.preview-mode .builder-item {
        cursor: default;
        padding: 6px 2px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
      }
      
      .builder-canvas.preview-mode .builder-item:last-child {
        border-bottom: none;
      }
      
      .builder-canvas.preview-mode .dark-theme .builder-item {
        border-bottom-color: rgba(255,255,255,0.12);
      }
      
      .builder-canvas.preview-mode .builder-item:hover {
        background: transparent;
      }
      
      /* Inputs look like text */
      .builder-canvas.preview-mode input {
        pointer-events: none;
        background: transparent !important;
        padding: 0 !important;
      }
      
      .builder-canvas.preview-mode input::placeholder {
        color: transparent !important;
      }
      
      /* Page header - clean centered text */
      .builder-canvas.preview-mode .builder-page-header {
        border: none !important;
      }
      
      .builder-canvas.preview-mode .builder-page-header:hover {
        background: transparent;
      }
      
      .builder-canvas.preview-mode .builder-page-header h1,
      .builder-canvas.preview-mode .builder-page-header h2,
      .builder-canvas.preview-mode .page-header-text {
        color: #000 !important;
      }
      
      /* Columns - no hover effects */
      .builder-canvas.preview-mode .builder-column {
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      }
      
      .builder-canvas.preview-mode .builder-column:hover {
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      }
      
      /* Light theme text */
      .builder-canvas.preview-mode .light-theme,
      .builder-canvas.preview-mode .light-theme input {
        color: #222 !important;
      }
      
      /* Dark theme text */
      .builder-canvas.preview-mode .dark-theme,
      .builder-canvas.preview-mode .dark-theme input {
        color: #fff !important;
      }
      
      /* Section headers in preview */
      .builder-canvas.preview-mode .section-header {
        padding: 8px 0 6px;
        cursor: default;
      }
      
      .builder-canvas.preview-mode .light-theme .section-header {
        border-bottom: 1px solid #ddd;
      }
      
      .builder-canvas.preview-mode .dark-theme .section-header {
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      /* ==================== VISUAL ROW STYLES ==================== */
      
      .section-title-dark {
        font-size: 1.2em;
        font-weight: 500;
        color: white;
      }
      
      .visual-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        padding: 10px 8px;
        border-bottom: 1px solid rgba(0,0,0,0.08);
        border-radius: 4px;
        background: rgba(255,255,255,0.5);
      }
      
      .visual-row:hover {
        background: rgba(255,255,255,0.9);
      }
      
      .visual-row.empty-row {
        opacity: 0.6;
        border-bottom: 1px dashed #ccc;
      }
      
      .visual-row.empty-row:hover {
        opacity: 1;
      }
      
      .visual-input {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px 12px;
        font-size: 0.95em;
        transition: all 0.2s;
        background: #fff;
      }
      
      .visual-input:focus {
        border-color: #0066cc;
        box-shadow: 0 0 0 2px rgba(0,102,204,0.2);
        outline: none;
      }
      
      .visual-input:hover {
        border-color: #999;
      }
      
      .name-input {
        flex: 2;
        min-width: 150px;
        font-weight: 500;
      }
      
      .price-input {
        flex: 1;
        min-width: 100px;
        text-align: right;
        font-weight: bold;
      }
      
      .price-input.wide {
        min-width: 120px;
      }
      
      .interval-input {
        width: 70px;
        flex: 0 0 70px;
        text-align: center;
        font-size: 0.85em;
        color: #666;
      }
      
      /* Brakes Column Styles */
      .visual-brake-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 14px 12px;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .visual-brake-row:hover {
        background: rgba(255,255,255,0.15);
      }
      
      .visual-brake-row.empty-row {
        background: rgba(255,255,255,0.05);
        border-style: dashed;
        opacity: 0.7;
      }
      
      .visual-brake-row.empty-row:hover {
        opacity: 1;
      }
      
      .brake-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
      }
      
      .brake-name-input {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        font-size: 1.1em;
        font-weight: 600;
        padding: 6px 10px;
        border-radius: 3px;
      }
      
      .brake-name-input:focus {
        border-color: #fff;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.1);
      }
      
      .brake-name-input::placeholder {
        color: rgba(255,255,255,0.5);
      }
      
      .brake-desc {
        font-size: 0.8em;
        color: rgba(255,255,255,0.7);
        padding-left: 10px;
      }
      
      .brake-price-input {
        background: white;
        border: 1px solid #ddd;
        font-size: 1.1em;
        font-weight: bold;
        padding: 8px 12px;
        text-align: center;
        min-width: 100px;
        border-radius: 3px;
      }
      
      .brake-price-input:focus {
        border-color: #0066cc;
        box-shadow: 0 0 0 2px rgba(0,102,204,0.3);
      }
      
      .brake-disclaimer {
        color: rgba(255,255,255,0.8);
        font-size: 0.85em;
        text-align: center;
        margin-top: 15px;
        font-style: italic;
      }
      
      .technet-logo {
        margin-top: 20px;
        text-align: center;
      }
      
      .technet-logo img {
        opacity: 0.9;
        filter: brightness(1.1);
      }
      
      /* Delete button for rows */
      .row-delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 4px 8px;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 14px;
      }
      
      .visual-row:hover .row-delete-btn,
      .visual-brake-row:hover .row-delete-btn {
        opacity: 1;
      }
      
      .row-delete-btn:hover {
        color: #a71d2a;
      }
      
      .visual-brake-row .row-delete-btn {
        color: #ff6b6b;
      }
      
      .visual-brake-row .row-delete-btn:hover {
        color: #ff4757;
      }
      
      /* Unsaved changes indicator */
      .visual-input.modified {
        background: #fffbeb;
        border-color: #f59e0b;
      }
      
      .visual-input.modified:focus {
        box-shadow: 0 0 0 2px rgba(245,158,11,0.3);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="l-header">
      <div class="l-subheader at_middle">
        <div class="l-subheader-h">
          <div class="l-subheader-cell">
            <a href="../" class="admin-brand">
              <img src="../assets/img/logo-01.png" alt="Quality Lube" style="height: 60px" />
              <span style="margin-left: 15px; vertical-align: middle">Admin Portal</span>
            </a>
          </div>
          <div class="l-subheader-cell">
            <button class="btn btn-outline-light btn-sm" id="logout-btn">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="container dashboard-container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 style="margin: 0">Admin Dashboard</h2>
        <div class="d-flex align-items-center gap-3">
          <span class="live-indicator">Live Updates</span>
          <span class="badge bg-success" id="connection-status">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-4" id="dashboardTabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#submissions-tab">
            <i class="fas fa-inbox me-2"></i>Form Submissions
            <span class="badge bg-danger ms-2" id="unread-count" style="display:none;">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#pricing-tab">
            <i class="fas fa-dollar-sign me-2"></i>Pricing Management
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#settings-tab">
            <i class="fas fa-cog me-2"></i>Settings
          </a>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Submissions Tab -->
        <div class="tab-pane fade show active" id="submissions-tab">
          <!-- Stats Bar -->
          <div class="stats-bar">
            <div class="stat-item">
              <div class="stat-number" id="stat-total">0</div>
              <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-unread">0</div>
              <div class="stat-label">Unread</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-today">0</div>
              <div class="stat-label">Today</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-appointments">0</div>
              <div class="stat-label">Appointments</div>
            </div>
          </div>

          <!-- Filter Bar -->
          <div class="filter-bar">
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Type</label>
              <select id="filter-type" class="form-select form-select-sm">
                <option value="">All Types</option>
                <option value="contact">Contact</option>
                <option value="appointment">Appointment</option>
                <option value="appointment_only">Appointment Only</option>
                <option value="self_check">Self-Check</option>
                <option value="lead_capture_start">Lead Capture</option>
                <option value="careers">Careers</option>
                <option value="quote">Quote Request</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Status</label>
              <select id="filter-status" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="unread">Unread</option>
                <option value="read">Read</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Date Range</label>
              <select id="filter-date" class="form-select form-select-sm">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Group By</label>
              <select id="filter-group" class="form-select form-select-sm">
                <option value="">No Grouping</option>
                <option value="date">Date</option>
                <option value="type">Type</option>
                <option value="date-type">Date then Type</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Search</label>
              <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Name, email, phone...">
            </div>
            <div class="ms-auto d-flex gap-2 align-items-end">
              <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="fas fa-times"></i> Clear
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="exportSubmissions()">
                <i class="fas fa-download"></i> Export CSV
              </button>
            </div>
          </div>

          <!-- Submissions List -->
          <div id="submissions-list">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Archived Submissions -->
          <div id="archived-section" style="display: none; margin-top: 24px;">
            <div class="card">
              <div class="card-header" style="cursor: pointer; user-select: none;" onclick="toggleArchivedSection()">
                <h6 class="mb-0 d-flex align-items-center justify-content-between">
                  <span><i class="fas fa-archive me-2"></i>Archived Submissions <span id="archived-count" class="badge bg-secondary ms-2">0</span></span>
                  <i id="archived-chevron" class="fas fa-chevron-down"></i>
                </h6>
              </div>
              <div id="archived-list" class="card-body" style="display: none; padding: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- Pricing Tab -->
        <div class="tab-pane fade" id="pricing-tab">
          <!-- Toolbar -->
          <div class="mb-4 d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-success" onclick="saveAllPrices()">
              <i class="fas fa-save"></i> Save All Changes
            </button>
            <button class="btn btn-secondary" onclick="loadVisualPricing()">
              <i class="fas fa-sync"></i> Refresh
            </button>
            <span class="text-muted ms-2" id="save-status"></span>
            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                <i class="fas fa-plus"></i> Add Service
              </button>
              <button class="btn btn-warning text-dark" onclick="reimportDefaults()">
                <i class="fas fa-history"></i> Reset Defaults
              </button>
            </div>
          </div>

          <div class="alert alert-info py-2">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Page Builder:</strong> Drag sections and items to reorder. Click any text to edit. Use the toolbar to add columns, sections, and items.
          </div>

          <div id="loading-spinner" class="text-center my-5" style="display:none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <!-- Visual Page Builder -->
          <div id="page-builder" class="page-builder-container">
            
            <!-- Builder Toolbar -->
            <div class="builder-toolbar">
              <button class="btn btn-tool" onclick="addColumn('light')" title="Add Light Column">
                <i class="fas fa-plus-square"></i> Add Column
              </button>
              <button class="btn btn-tool" onclick="addColumn('dark')" title="Add Dark Column">
                <i class="fas fa-plus-square"></i> Add Dark Column
              </button>
              <div class="toolbar-divider"></div>
              <button class="btn btn-tool" id="preview-toggle" onclick="togglePreviewMode()">
                <i class="fas fa-eye"></i> Preview
              </button>
              <div class="toolbar-divider"></div>
              <button class="btn btn-tool" onclick="undoChange()" title="Undo">
                <i class="fas fa-undo"></i>
              </button>
              <button class="btn btn-tool" onclick="redoChange()" title="Redo">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            
            <!-- Builder Canvas - The actual page editor -->
            <div class="builder-canvas" id="builder-canvas">
              
              <!-- Page Header (editable) -->
              <div class="builder-page-header">
                <h2 style="margin: 0; font-style: italic; font-weight: 400; color: #000000;">
                  <input type="text" class="editable-text page-header-text" id="header-line1" value="WELCOME TO" style="font-style: italic; font-weight: 400; font-size: 1em; color: #000000;">
                </h2>
                <h1 style="margin: 0; font-weight: bold; color: #000000;">
                  <input type="text" class="editable-text page-header-text" id="header-line2" value="QUALITY LUBE EXPRESS" style="font-weight: bold; font-size: 2em; color: #000000;">
                </h1>
              </div>
              
              <!-- Columns Container -->
              <div class="builder-columns" id="columns-container">
                <!-- Columns will be dynamically generated -->
              </div>
              
            </div>
          </div>

          <!-- Legacy Table View (Hidden by default, can be toggled) -->
          <div id="legacy-table-view" style="display: none;">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-dark">
                  <tr>
                    <th style="width: 50%">Service Name</th>
                    <th>Price</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="services-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings-tab">
          <div class="card">
            <div class="card-body">
              <h5>Dashboard Settings</h5>
              <hr>
              <h6>Notification Settings</h6>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="sound-notifications" checked>
                <label class="form-check-label" for="sound-notifications">Play sound for new submissions</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="browser-notifications">
                <label class="form-check-label" for="browser-notifications">Browser notifications</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Reply Modal -->
    <div class="modal fade" id="quickReplyModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-reply me-2"></i>Quick Reply</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">To:</label>
              <input type="text" class="form-control" id="reply-to" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Quick Templates:</label>
              <div class="quick-reply-options">
                <button class="quick-reply-btn" onclick="useTemplate('appointment_confirm')">
                  <i class="fas fa-calendar-check"></i>Confirm Appointment
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('callback')">
                  <i class="fas fa-phone"></i>Will Call Back
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('quote')">
                  <i class="fas fa-file-invoice-dollar"></i>Quote/Estimate
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('thank_you')">
                  <i class="fas fa-heart"></i>Thank You
                </button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Message:</label>
              <textarea class="form-control" id="reply-message" rows="6"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <a href="#" class="btn btn-success" id="send-email-btn">
              <i class="fas fa-envelope me-2"></i>Open in Email
            </a>
            <a href="#" class="btn btn-primary" id="send-sms-btn">
              <i class="fas fa-sms me-2"></i>Open in SMS
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="viewDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Submission Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="details-content">
            <!-- Content loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inspection Results Modal -->
    <div class="modal fade" id="inspectionResultsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title"><i class="fas fa-clipboard-check me-2 text-success"></i>Vehicle Self-Inspection Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="inspection-results-content">
            <!-- Content loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" onclick="printInspectionResults()">
              <i class="fas fa-print me-1"></i>Print Report
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Service Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="service-form">
              <input type="hidden" id="service-id" />
              <div class="mb-3">
                <label class="form-label">Service Name</label>
                <input type="text" class="form-control" id="service-name" required placeholder="e.g. Mobil 1" />
              </div>
              <div class="mb-3">
                <label class="form-label">Price / Description</label>
                <input type="text" class="form-control" id="service-price" required placeholder="e.g. $89.99 10k/Mi" />
              </div>
              <div class="mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="service-category">
                  <option value="Oil">Oil</option>
                  <option value="Brakes">Brakes</option>
                  <option value="Tires">Tires</option>
                  <option value="General">General</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-service-btn">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notification-sound" preload="auto">
      <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+PfXFxgI2Xk4N0bXOAipOOgXRvcX2Ii4mAdnBxe4SGhH53c3R7gIKAfXl3d3t+f358enl5e31+fXx7e3t8fX19fHt7e3x9fX18fHx8fX19fXx8fH19fX19fHx9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fHx8fH19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fQ==" type="audio/wav">
    </audio>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyA2DI7LRK4kR7DZtGRridtmCZYl8F32cLg",
        authDomain: "qualityexpress-c19f2.firebaseapp.com",
        projectId: "qualityexpress-c19f2",
        storageBucket: "qualityexpress-c19f2.firebasestorage.app",
        messagingSenderId: "201962327491",
        appId: "1:201962327491:web:342d771b9013d901cc8176",
        measurementId: "G-HJDBXM5CLX",
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let allSubmissions = [];
      let allServices = [];
      let unsubscribe = null;
      let currentReplyData = null;

      // Auth Guard
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../login.html';
        } else {
          initLiveSubmissions();
          loadServices();
          requestNotificationPermission();
        }
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        if (unsubscribe) unsubscribe();
        auth.signOut().then(() => (window.location.href = '../index.html'));
      });

      // Request notification permission
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
          document.getElementById('browser-notifications').addEventListener('change', function() {
            if (this.checked) {
              Notification.requestPermission();
            }
          });
        }
      }

      // ==================== FORM SUBMISSIONS ====================

      // Initialize real-time listener for form submissions
      function initLiveSubmissions() {
        // Real-time listener - fetch all and sort client-side to avoid index requirements
        unsubscribe = db.collection('form_submissions')
          .limit(500)
          .onSnapshot((snapshot) => {
            const previousCount = allSubmissions.length;
            allSubmissions = [];
            snapshot.forEach((doc) => {
              allSubmissions.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by timestamp/date descending (client-side)
            allSubmissions.sort((a, b) => {
              const dateA = getSubmissionDate(a) || new Date(0);
              const dateB = getSubmissionDate(b) || new Date(0);
              return dateB - dateA;
            });
            
            // Check for new submissions
            if (previousCount > 0 && allSubmissions.length > previousCount) {
              playNotificationSound();
              showBrowserNotification(allSubmissions[0]);
            }
            
            updateStats();
            renderSubmissions();
          }, (error) => {
            console.error('Error listening to submissions:', error);
            document.getElementById('submissions-list').innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error loading submissions: ${error.message}
              </div>
            `;
          });
      }

      // Play notification sound
      function playNotificationSound() {
        if (document.getElementById('sound-notifications')?.checked) {
          const audio = document.getElementById('notification-sound');
          audio.currentTime = 0;
          audio.play().catch(() => {});
        }
      }

      // Show browser notification
      function showBrowserNotification(submission) {
        if (document.getElementById('browser-notifications')?.checked && 
            'Notification' in window && 
            Notification.permission === 'granted') {
          const name = submission.name || submission.first_name || 'Someone';
          new Notification('New Form Submission', {
            body: `${name} submitted a ${submission.form_type || 'contact'} form`,
            icon: '../assets/img/logo-01.png'
          });
        }
      }

      // Get submission date (handles multiple date field names + Firestore Timestamps)
      function getSubmissionDate(sub) {
        const raw = sub.timestamp || sub.date || sub.submitted_at || sub.createdAt;
        if (!raw) return null;
        // Handle Firestore Timestamp objects (have .toDate())
        if (raw && typeof raw.toDate === 'function') return raw.toDate();
        // Handle Firestore Timestamp-like objects with seconds
        if (raw && typeof raw === 'object' && raw.seconds) return new Date(raw.seconds * 1000);
        const d = new Date(raw);
        return isNaN(d.getTime()) ? null : d;
      }

      // Update statistics
      function updateStats() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        // Exclude archived submissions from stats
        const activeSubs = allSubmissions.filter(s => !s.archived);
        const total = activeSubs.length;
        const unread = activeSubs.filter(s => !s.read).length;
        const todayCount = activeSubs.filter(s => {
          const subDate = getSubmissionDate(s);
          return subDate && subDate >= today;
        }).length;
        const appointments = activeSubs.filter(s => 
          s.form_type === 'appointment' || s.appointment_request
        ).length;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-unread').textContent = unread;
        document.getElementById('stat-today').textContent = todayCount;
        document.getElementById('stat-appointments').textContent = appointments;

        // Update unread badge
        const badge = document.getElementById('unread-count');
        if (unread > 0) {
          badge.textContent = unread;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }

      // Toggle archived section visibility
      function toggleArchivedSection() {
        const list = document.getElementById('archived-list');
        const chevron = document.getElementById('archived-chevron');
        if (list.style.display === 'none') {
          list.style.display = 'block';
          chevron.className = 'fas fa-chevron-up';
        } else {
          list.style.display = 'none';
          chevron.className = 'fas fa-chevron-down';
        }
      }

      // Render submissions with filters
      function renderSubmissions() {
        const container = document.getElementById('submissions-list');
        
        // Separate archived from active
        const activeSubmissions = allSubmissions.filter(s => !s.archived);
        const archivedSubmissions = allSubmissions.filter(s => s.archived);

        // Render archived section
        const archivedSection = document.getElementById('archived-section');
        const archivedList = document.getElementById('archived-list');
        const archivedCount = document.getElementById('archived-count');
        if (archivedSubmissions.length > 0) {
          archivedSection.style.display = 'block';
          archivedCount.textContent = archivedSubmissions.length;
          archivedList.innerHTML = archivedSubmissions.map(sub => renderArchivedCard(sub)).join('');
        } else {
          archivedSection.style.display = 'none';
        }

        // Apply filters to active submissions only
        let filtered = [...activeSubmissions];
        
        const typeFilter = document.getElementById('filter-type').value;
        const statusFilter = document.getElementById('filter-status').value;
        const dateFilter = document.getElementById('filter-date').value;
        const searchFilter = document.getElementById('filter-search').value.toLowerCase();

        if (typeFilter) {
          filtered = filtered.filter(s => getFormType(s) === typeFilter);
        }

        if (statusFilter === 'unread') {
          filtered = filtered.filter(s => !s.read);
        } else if (statusFilter === 'read') {
          filtered = filtered.filter(s => s.read);
        }

        if (dateFilter) {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          let startDate;
          
          if (dateFilter === 'today') {
            startDate = today;
          } else if (dateFilter === 'week') {
            startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 7);
          } else if (dateFilter === 'month') {
            startDate = new Date(today);
            startDate.setMonth(startDate.getMonth() - 1);
          }
          
          if (startDate) {
            filtered = filtered.filter(s => {
              const subDate = getSubmissionDate(s);
              return subDate && subDate >= startDate;
            });
          }
        }

        if (searchFilter) {
          filtered = filtered.filter(s => {
            const searchStr = [
              s.name, s.email, s.phone, s.message, s.form_name, s.vehicle,
              s['wpforms[fields][1][first]'], s['wpforms[fields][1][last]'],
              s['wpforms[fields][3]'], s['wpforms[fields][4]'], s['wpforms[fields][5]'],
              s.raw_data
            ].filter(Boolean).join(' ').toLowerCase();
            return searchStr.includes(searchFilter);
          });
        }

        if (filtered.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h5>No Submissions Found</h5>
              <p>No form submissions match your current filters.</p>
            </div>
          `;
          return;
        }

        // Apply grouping
        const groupBy = document.getElementById('filter-group').value;
        
        if (!groupBy) {
          container.innerHTML = filtered.map(sub => renderSubmissionCard(sub)).join('');
        } else {
          container.innerHTML = renderGroupedSubmissions(filtered, groupBy);
        }
      }

      // Render grouped submissions
      function renderGroupedSubmissions(submissions, groupBy) {
        let html = '';
        
        if (groupBy === 'date' || groupBy === 'date-type') {
          // Group by date first
          const byDate = {};
          submissions.forEach(sub => {
            const date = getSubmissionDate(sub);
            const dateKey = date ? date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Unknown Date';
            if (!byDate[dateKey]) byDate[dateKey] = [];
            byDate[dateKey].push(sub);
          });
          
          for (const [dateKey, dateSubs] of Object.entries(byDate)) {
            if (groupBy === 'date-type') {
              // Further group by type within each date
              const byType = {};
              dateSubs.forEach(sub => {
                const type = getFormType(sub);
                if (!byType[type]) byType[type] = [];
                byType[type].push(sub);
              });
              
              html += `<div class="group-header date-header"><i class="fas fa-calendar me-2"></i>${dateKey}</div>`;
              
              for (const [typeKey, typeSubs] of Object.entries(byType)) {
                const typeName = getFormTypeName(typeKey);
                html += `<div class="group-header type-subheader"><i class="fas fa-tag me-2"></i>${typeName} (${typeSubs.length})</div>`;
                html += typeSubs.map(sub => renderSubmissionCard(sub)).join('');
              }
            } else {
              html += `<div class="group-header date-header"><i class="fas fa-calendar me-2"></i>${dateKey} (${dateSubs.length})</div>`;
              html += dateSubs.map(sub => renderSubmissionCard(sub)).join('');
            }
          }
        } else if (groupBy === 'type') {
          // Group by type only
          const byType = {};
          submissions.forEach(sub => {
            const type = getFormType(sub);
            if (!byType[type]) byType[type] = [];
            byType[type].push(sub);
          });
          
          for (const [typeKey, typeSubs] of Object.entries(byType)) {
            const typeName = getFormTypeName(typeKey);
            html += `<div class="group-header type-header"><i class="fas fa-tag me-2"></i>${typeName} (${typeSubs.length})</div>`;
            html += typeSubs.map(sub => renderSubmissionCard(sub)).join('');
          }
        }
        
        return html;
      }

      // Determine form type from submission data
      function getFormType(sub) {
        // If form_type is explicitly set, use it
        if (sub.form_type) return sub.form_type;
        
        // Try to infer from form_name
        const formName = (sub.form_name || '').toLowerCase();
        const formId = (sub.form_id || '').toLowerCase();
        
        if (formName.includes('career') || formName.includes('job') || formName.includes('employment')) {
          return 'careers';
        }
        if (formName.includes('appointment') || formName.includes('schedule')) {
          return 'appointment';
        }
        // Check for self-check/safety inspection forms
        if (formName.includes('self-check') || formName.includes('self check') || 
            formName.includes('safety self') || formName.includes('vehicle safety') ||
            formName.includes('inspection') || sub.items) {
          return 'self_check';
        }
        if (formName.includes('quote') || formName.includes('estimate')) {
          return 'quote';
        }
        if (formName.includes('contact')) {
          return 'contact';
        }
        
        // Check form_id patterns
        if (formId.includes('career') || formId.includes('job')) {
          return 'careers';
        }
        if (formId.includes('appointment') || formId.includes('schedule')) {
          return 'appointment';
        }
        if (formId.includes('contact')) {
          return 'contact';
        }
        
        // Check fields for clues - wpforms uses bracket notation
        const allFields = Object.keys(sub).join(' ').toLowerCase();
        
        if (allFields.includes('resume') || allFields.includes('position') || allFields.includes('job')) {
          return 'careers';
        }
        if (allFields.includes('appointment') || allFields.includes('schedule')) {
          return 'appointment';
        }
        
        // Default to contact
        return 'contact';
      }

      // Get readable name for form type
      function getFormTypeName(type) {
        const typeNames = {
          'contact': 'Contact Forms',
          'appointment': 'Appointments',
          'appointment_only': 'Appointment Requests',
          'self_check': 'Vehicle Self-Check',
          'lead_capture_start': 'Lead Captures',
          'careers': 'Career Applications',
          'quote': 'Quote Requests',
          'other': 'Other'
        };
        return typeNames[type] || type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }

      // Render individual submission card
      function renderSubmissionCard(sub, isArchived) {
        const date = getSubmissionDate(sub);
        const dateStr = date ? date.toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        }) : 'Unknown date';

        const formType = getFormType(sub);
        const typeClass = formType;
        const typeName = sub.form_name || getFormTypeName(formType);
        
        // Handle various field name formats (wpforms uses bracket notation)
        const firstName = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || '';
        const lastName = sub.last_name || sub['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName || 'Unknown');
        
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';
        const message = sub.message || sub.comments || sub['wpforms[fields][5]'] || sub['wpforms[fields][6]'] || '';
        const vehicle = sub.vehicle || sub['wpforms[fields][7]'] || '';
        
        return `
          <div class="submission-card ${sub.read ? 'read' : 'unread'}" data-id="${sub.id}">
            <div class="submission-header">
              <div>
                <span class="submission-type ${typeClass}">${typeName}</span>
                <h5 style="margin: 8px 0 0; font-size: 18px;">${escapeHtml(name)}</h5>
              </div>
              <div class="submission-meta">
                ${dateStr}
                ${!sub.read ? '<span class="badge bg-danger ms-2">NEW</span>' : ''}
              </div>
            </div>
            
            <div class="submission-contact">
              ${email ? `
                <div class="submission-contact-item">
                  <i class="fas fa-envelope"></i>
                  <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>
                </div>
              ` : ''}
              ${phone ? `
                <div class="submission-contact-item">
                  <i class="fas fa-phone"></i>
                  <a href="tel:${escapeHtml(phone)}">${escapeHtml(phone)}</a>
                </div>
              ` : ''}
              ${vehicle ? `
                <div class="submission-contact-item">
                  <i class="fas fa-car"></i>
                  <span>${escapeHtml(vehicle)}</span>
                </div>
              ` : ''}
            </div>
            
            ${message ? `<div class="submission-message">${escapeHtml(message.length > 200 ? message.substring(0, 200) + '...' : message)}</div>` : ''}
            
            ${formType === 'self_check' && sub.items ? renderInspectionPreview(sub) : ''}
            
            <div class="submission-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="quickReply('${sub.id}')">
                <i class="fas fa-reply me-1"></i>Quick Reply
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('${sub.id}')">
                <i class="fas fa-eye me-1"></i>View Details
              </button>
              ${formType === 'self_check' && sub.items ? `
                <button class="btn btn-sm btn-outline-info" onclick="viewInspectionResults('${sub.id}')">
                  <i class="fas fa-clipboard-check me-1"></i>View Inspection
                </button>
              ` : ''}
              ${!sub.read ? `
                <button class="btn btn-sm btn-outline-success" onclick="markAsRead('${sub.id}')">
                  <i class="fas fa-check me-1"></i>Mark Read
                </button>
              ` : `
                <button class="btn btn-sm btn-outline-warning" onclick="markAsUnread('${sub.id}')">
                  <i class="fas fa-undo me-1"></i>Mark Unread
                </button>
              `}
              ${isArchived ? `
                <button class="btn btn-sm btn-outline-success" onclick="unarchiveSubmission('${sub.id}')">
                  <i class="fas fa-undo me-1"></i>Unarchive
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="permanentlyDelete('${sub.id}')">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              ` : `
                <button class="btn btn-sm btn-outline-secondary" onclick="archiveSubmission('${sub.id}')">
                  <i class="fas fa-archive me-1"></i>Archive
                </button>
              `}
            </div>
          </div>
        `;
      }

      // Render archived submission card (full card with unarchive/delete instead of archive)
      function renderArchivedCard(sub) {
        return renderSubmissionCard(sub, true);
      // Mark as read
      function markAsRead(id) {
        db.collection('form_submissions').doc(id).update({ read: true });
      }

      // Mark as unread  
      function markAsUnread(id) {
        db.collection('form_submissions').doc(id).update({ read: false });
      }

      // Archive submission (soft delete)
      function archiveSubmission(id) {
        db.collection('form_submissions').doc(id).update({ archived: true });
      }

      // Unarchive submission
      function unarchiveSubmission(id) {
        db.collection('form_submissions').doc(id).update({ archived: false });
      }

      // Permanently delete submission
      function permanentlyDelete(id) {
        if (confirm('Are you sure you want to permanently delete this submission? This cannot be undone.')) {
          db.collection('form_submissions').doc(id).delete();
        }
      }

      // View full details
      function viewDetails(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub) return;

        // Mark as read
        markAsRead(id);

        // Keys to hide from details view
        const hiddenKeys = new Set([
          'id', 'read', 'archived', 'site', 'form_id', 'form_name', 'spam_check',
          'captcha_token', 'h-captcha-response', 'g-recaptcha-response',
          'page_id', 'page_title', 'url_referer', 'fields', 'raw_data',
          'timestamp', 'date', 'submitted_at', 'createdAt'
        ]);

        // Extract clean display fields
        const displayFields = {};
        const f = sub.fields || {};

        // Pull from nested fields first
        for (const [key, value] of Object.entries(f)) {
          if (hiddenKeys.has(key)) continue;
          const val = String(value || '');
          if (val.length > 200 && (val.startsWith('eyJ') || val.startsWith('P1_'))) continue;
          if (['page_url', 'page_id', 'page_title', 'url_referer', 'h-captcha-response', 'g-recaptcha-response'].includes(key)) continue;
          displayFields[key] = val;
        }

        // Pull from top-level for flat-format submissions
        for (const [key, value] of Object.entries(sub)) {
          if (hiddenKeys.has(key) || typeof value === 'object') continue;
          const val = String(value || '');
          if (val.length > 200 && (val.startsWith('eyJ') || val.startsWith('P1_'))) continue;
          if (['page_url', 'page_id', 'page_title', 'url_referer'].includes(key)) continue;
          const labelKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          if (!displayFields[key] && !displayFields[labelKey]) {
            displayFields[labelKey] = val;
          }
        }

        // Build readable name
        const name = displayFields['Name'] || displayFields['First Name'] || displayFields['First'] || sub.name || '';

        // Date
        const subDate = getSubmissionDate(sub);
        const dateStr = subDate ? subDate.toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        }) : 'Unknown';

        // Build HTML
        let html = `
          <div class="mb-3 p-3" style="background:#f0f7ff;border-radius:8px;border-left:4px solid #007bff;">
            <h5 style="margin:0;color:#007bff;">${escapeHtml(name || 'Submission')}</h5>
            <small class="text-muted">${escapeHtml(sub.form_name || 'Form Submission')} &bull; ${dateStr}</small>
          </div>
          <table class="table table-bordered">
            <tbody>
        `;

        let isAlt = false;
        for (const [key, value] of Object.entries(displayFields)) {
          if (!value || value === 'undefined') continue;
          const bg = isAlt ? '#f9f9f9' : '#ffffff';
          html += `
            <tr style="background:${bg}">
              <th style="width:180px;background:#f4f4f4;font-weight:600;">${escapeHtml(key)}</th>
              <td style="white-space:pre-wrap;">${escapeHtml(value)}</td>
            </tr>
          `;
          isAlt = !isAlt;
        }

        // Add page URL at bottom as metadata
        const pageUrl = sub.page_url || (f && f.page_url) || '';
        if (pageUrl) {
          html += `
            <tr style="background:#fafafa">
              <th style="width:180px;background:#f4f4f4;font-weight:600;">Page</th>
              <td><a href="${escapeHtml(pageUrl)}" target="_blank">${escapeHtml(pageUrl)}</a></td>
            </tr>
          `;
        }

        html += '</tbody></table>';

        document.getElementById('details-content').innerHTML = html;
        new bootstrap.Modal(document.getElementById('viewDetailsModal')).show();
      }

      // Quick reply
      function quickReply(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub) return;

        currentReplyData = sub;
        
        // Handle various field name formats (wpforms uses bracket notation)
        const firstName = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || '';
        const lastName = sub.last_name || sub['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName || 'Customer');
        
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';

        document.getElementById('reply-to').value = `${name} - ${email || phone}`;
        document.getElementById('reply-message').value = '';

        // Set up email link
        const emailBtn = document.getElementById('send-email-btn');
        emailBtn.onclick = () => {
          const message = encodeURIComponent(document.getElementById('reply-message').value);
          const subject = encodeURIComponent("Re: Your inquiry at Quality Lube Express");
          window.location.href = `mailto:${email}?subject=${subject}&body=${message}`;
        };

        // Set up SMS link
        const smsBtn = document.getElementById('send-sms-btn');
        smsBtn.onclick = () => {
          const message = encodeURIComponent(document.getElementById('reply-message').value);
          const cleanPhone = phone.replace(/\D/g, '');
          window.location.href = `sms:${cleanPhone}?body=${message}`;
        };

        new bootstrap.Modal(document.getElementById('quickReplyModal')).show();
      }

      // Template messages
      function useTemplate(type) {
        // Handle various field name formats for name
        const firstName = currentReplyData?.name || currentReplyData?.first_name || currentReplyData?.['wpforms[fields][1][first]'] || '';
        const lastName = currentReplyData?.last_name || currentReplyData?.['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName}` : (firstName || 'there');
        
        const templates = {
          appointment_confirm: `Hi ${name},\n\nThank you for scheduling an appointment with Quality Lube Express!\n\nWe've received your request and will contact you shortly to confirm the date and time.\n\nIf you have any questions, feel free to call us at (940) 566-5169.\n\nThank you,\nQuality Lube Express`,
          callback: `Hi ${name},\n\nThank you for reaching out to Quality Lube Express!\n\nWe've received your message and will give you a call back shortly.\n\nIf this is urgent, please call us directly at (940) 566-5169.\n\nThank you,\nQuality Lube Express`,
          quote: `Hi ${name},\n\nThank you for your inquiry at Quality Lube Express!\n\nBased on your request, here's what we can offer:\n\n[Quote details here]\n\nPlease let us know if you have any questions or would like to schedule an appointment.\n\nThank you,\nQuality Lube Express`,
          thank_you: `Hi ${name},\n\nThank you for choosing Quality Lube Express!\n\nWe appreciate your business and look forward to serving you again.\n\nIf you have any questions or need anything else, don't hesitate to reach out.\n\nThank you,\nQuality Lube Express`
        };
        
        document.getElementById('reply-message').value = templates[type] || '';
      }

      // Filter event listeners
      ['filter-type', 'filter-status', 'filter-date', 'filter-group'].forEach(id => {
        document.getElementById(id).addEventListener('change', renderSubmissions);
      });
      document.getElementById('filter-search').addEventListener('input', debounce(renderSubmissions, 300));

      // Clear filters
      function clearFilters() {
        document.getElementById('filter-type').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-group').value = '';
        document.getElementById('filter-search').value = '';
        renderSubmissions();
      }

      // Export to CSV
      function exportSubmissions() {
        const headers = ['Date', 'Type', 'Name', 'Email', 'Phone', 'Vehicle', 'Message', 'Read'];
        const rows = allSubmissions.map(sub => [
          sub.timestamp || '',
          sub.form_type || '',
          sub.name || sub.first_name || '',
          sub.email || '',
          sub.phone || '',
          sub.vehicle || '',
          (sub.message || sub.comments || '').replace(/[\n\r]/g, ' '),
          sub.read ? 'Yes' : 'No'
        ]);

        let csv = headers.join(',') + '\n';
        rows.forEach(row => {
          csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `form-submissions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      }

      // ==================== PAGE BUILDER FOR PRICING ====================

      // Page Builder State
      let pageData = {
        header: {
          line1: 'WELCOME TO',
          line2: 'QUALITY LUBE EXPRESS'
        },
        columns: []
      };
      let undoStack = [];
      let redoStack = [];
      let hasUnsavedChanges = false;
      let isPreviewMode = false;

      // Initialize Page Builder
      function initPageBuilder() {
        loadPageData();
      }

      // Load page data from Firebase
      async function loadPageData() {
        document.getElementById('loading-spinner').style.display = 'block';
        
        try {
          // First, try to load the page structure
          const structureDoc = await db.collection('pricing_page').doc('structure').get();
          
          if (structureDoc.exists) {
            pageData = structureDoc.data();
          } else {
            // Create default structure from existing services
            await createDefaultStructure();
          }
          
          renderPageBuilder();
          
        } catch (error) {
          console.error('Error loading page data:', error);
          // Fallback to creating default structure
          await createDefaultStructure();
          renderPageBuilder();
        } finally {
          document.getElementById('loading-spinner').style.display = 'none';
        }
      }

      // Create default structure from existing pricing_services
      async function createDefaultStructure() {
        try {
          const snapshot = await db.collection('pricing_services').get();
          const services = [];
          snapshot.forEach(doc => services.push({ id: doc.id, ...doc.data() }));
          
          // Group by category
          const oilServices = services.filter(s => s.category === 'Oil' || !s.category || s.category === 'General');
          const brakeServices = services.filter(s => s.category === 'Brakes');
          const tireServices = services.filter(s => s.category === 'Tires');
          
          // Create sub-sections for Oil column
          const syntheticServices = oilServices.filter(s => {
            const n = s.name.toUpperCase();
            return n.includes('MOBIL') || n.includes('MOBILE') || (n.includes('SYNTHETIC') && !n.includes('DIESEL'));
          });
          
          const dieselServices = oilServices.filter(s => {
            const n = s.name.toUpperCase();
            return n.includes('DIESEL') || n.includes('DELVAC') || n.includes('ROTELLA');
          });
          
          const wiperServices = oilServices.filter(s => {
            const n = s.name.toUpperCase();
            return n.includes('WIPER') || n.includes('BLADE');
          });

          pageData = {
            header: {
              line1: 'WELCOME TO',
              line2: 'QUALITY LUBE EXPRESS'
            },
            columns: [
              {
                id: 'col-oil',
                title: 'OIL',
                theme: 'light',
                sections: [
                  {
                    id: 'sec-synthetic',
                    name: 'FULL SYNTHETIC',
                    subtitle: '5QTs',
                    items: syntheticServices.map(s => ({ id: s.id, name: s.name, price: s.price }))
                  },
                  {
                    id: 'sec-diesel',
                    name: 'DIESEL OIL CHANGE',
                    subtitle: '10/QT',
                    items: dieselServices.map(s => ({ id: s.id, name: s.name, price: s.price }))
                  },
                  {
                    id: 'sec-wipers',
                    name: 'WIPER BLADES',
                    subtitle: '',
                    items: wiperServices.map(s => ({ id: s.id, name: s.name, price: s.price }))
                  }
                ],
                footer: ''
              },
              {
                id: 'col-brakes',
                title: 'BRAKES',
                theme: 'dark',
                sections: [
                  {
                    id: 'sec-brakes',
                    name: '',
                    subtitle: '',
                    items: brakeServices.map(s => ({ id: s.id, name: s.name, price: s.price }))
                  }
                ],
                footer: '*PRICES FOR MOST CARS/TRUCKS',
                showLogo: true
              },
              {
                id: 'col-tires',
                title: 'TIRES',
                theme: 'light',
                sections: [
                  {
                    id: 'sec-tires',
                    name: '',
                    subtitle: '',
                    items: tireServices.map(s => ({ id: s.id, name: s.name, price: s.price }))
                  }
                ],
                footer: ''
              }
            ]
          };
          
        } catch (error) {
          console.error('Error creating default structure:', error);
          // Create minimal default
          pageData = {
            header: { line1: 'WELCOME TO', line2: 'QUALITY LUBE EXPRESS' },
            columns: []
          };
        }
      }

      // Render the entire page builder
      function renderPageBuilder() {
        // Update header inputs
        document.getElementById('header-line1').value = pageData.header?.line1 || 'WELCOME TO';
        document.getElementById('header-line2').value = pageData.header?.line2 || 'QUALITY LUBE EXPRESS';
        
        // Render columns
        const container = document.getElementById('columns-container');
        container.innerHTML = '';
        
        pageData.columns.forEach((column, colIndex) => {
          container.innerHTML += renderColumn(column, colIndex);
        });
        
        // Add "Add Column" button
        container.innerHTML += `
          <div class="add-column-btn" onclick="addColumn('light')">
            <i class="fas fa-plus-circle"></i>
            <span>Add Column</span>
          </div>
        `;
        
        // Setup drag and drop
        setupDragAndDrop();
      }

      // Render a single column
      function renderColumn(column, colIndex) {
        const isDark = column.theme === 'dark';
        const themeClass = isDark ? 'dark-theme' : 'light-theme';
        const isFirst = colIndex === 0;
        const isLast = colIndex === pageData.columns.length - 1;
        
        let sectionsHtml = column.sections.map((section, secIndex) => 
          renderSection(section, colIndex, secIndex, isDark)
        ).join('');
        
        let footerHtml = '';
        if (column.footer) {
          footerHtml += `<div class="column-footer">${escapeHtml(column.footer)}</div>`;
        }
        if (column.showLogo) {
          footerHtml += `<div class="column-footer"><img src="../assets/img/technet-warranty-logo.png" alt="TechNet" style="max-width: 120px; opacity: 0.9;"></div>`;
        }
        
        return `
          <div class="builder-column ${themeClass}" data-col-index="${colIndex}">
            <div class="column-header">
              <div class="column-reorder-btns">
                <button class="reorder-btn-horiz ${isFirst ? 'disabled' : ''}" onclick="moveColumnLeft(${colIndex})" title="Move Left" ${isFirst ? 'disabled' : ''}>
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="reorder-btn-horiz ${isLast ? 'disabled' : ''}" onclick="moveColumnRight(${colIndex})" title="Move Right" ${isLast ? 'disabled' : ''}>
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <h3 class="column-title">
                <input type="text" value="${escapeHtml(column.title)}" 
                       onchange="updateColumnTitle(${colIndex}, this.value)"
                       placeholder="Column Title">
              </h3>
              <div class="column-controls">
                <button class="btn btn-sm ${isDark ? 'btn-outline-light' : 'btn-outline-secondary'}" 
                        onclick="toggleColumnTheme(${colIndex})" title="Toggle Theme">
                  <i class="fas fa-adjust"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteColumn(${colIndex})" title="Delete Column">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="column-content">
              <div class="sections-container" data-col-index="${colIndex}">
                ${sectionsHtml}
              </div>
              <button class="add-section-btn" onclick="addSection(${colIndex})">
                <i class="fas fa-plus"></i> Add Section
              </button>
            </div>
            ${footerHtml}
          </div>
        `;
      }

      // Render a section within a column
      function renderSection(section, colIndex, secIndex, isDark) {
        let itemsHtml = section.items.map((item, itemIndex) => 
          renderItem(item, colIndex, secIndex, itemIndex, isDark)
        ).join('');
        
        const showHeader = section.name || section.subtitle;
        const sectionsCount = pageData.columns[colIndex].sections.length;
        const isFirst = secIndex === 0;
        const isLast = secIndex === sectionsCount - 1;
        
        return `
          <div class="builder-section" data-col-index="${colIndex}" data-sec-index="${secIndex}">
            <div class="section-header">
              <div class="section-reorder-btns">
                <button class="reorder-btn ${isFirst ? 'disabled' : ''}" onclick="moveSectionUp(${colIndex}, ${secIndex})" title="Move Section Up" ${isFirst ? 'disabled' : ''}>
                  <i class="fas fa-chevron-up"></i>
                </button>
                <button class="reorder-btn ${isLast ? 'disabled' : ''}" onclick="moveSectionDown(${colIndex}, ${secIndex})" title="Move Section Down" ${isLast ? 'disabled' : ''}>
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
              <div class="section-name">
                <input type="text" value="${escapeHtml(section.name || '')}" 
                       onchange="updateSectionName(${colIndex}, ${secIndex}, this.value)"
                       placeholder="Section Name (optional)">
              </div>
              <div class="section-subtitle">
                <input type="text" value="${escapeHtml(section.subtitle || '')}" 
                       onchange="updateSectionSubtitle(${colIndex}, ${secIndex}, this.value)"
                       placeholder="Subtitle">
              </div>
              <div class="section-controls">
                <button class="btn btn-sm ${isDark ? 'btn-outline-light' : 'btn-outline-secondary'}" 
                        onclick="deleteSection(${colIndex}, ${secIndex})" title="Delete Section">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="items-container" data-col-index="${colIndex}" data-sec-index="${secIndex}">
              ${itemsHtml}
            </div>
            <button class="add-item-btn" onclick="addItem(${colIndex}, ${secIndex})">
              <i class="fas fa-plus"></i> Add Item
            </button>
          </div>
        `;
      }

      // Render a single item
      function renderItem(item, colIndex, secIndex, itemIndex, isDark) {
        const isFirst = itemIndex === 0;
        const itemsCount = pageData.columns[colIndex].sections[secIndex].items.length;
        const isLast = itemIndex === itemsCount - 1;
        
        return `
          <div class="builder-item" data-col-index="${colIndex}" data-sec-index="${secIndex}" data-item-index="${itemIndex}">
            <div class="item-reorder-btns">
              <button class="reorder-btn ${isFirst ? 'disabled' : ''}" onclick="moveItemUp(${colIndex}, ${secIndex}, ${itemIndex})" title="Move Up" ${isFirst ? 'disabled' : ''}>
                <i class="fas fa-chevron-up"></i>
              </button>
              <button class="reorder-btn ${isLast ? 'disabled' : ''}" onclick="moveItemDown(${colIndex}, ${secIndex}, ${itemIndex})" title="Move Down" ${isLast ? 'disabled' : ''}>
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>
            <div class="item-name">
              <input type="text" value="${escapeHtml(item.name)}" 
                     onchange="updateItemName(${colIndex}, ${secIndex}, ${itemIndex}, this.value)"
                     placeholder="Service Name">
            </div>
            <div class="item-price">
              <input type="text" value="${escapeHtml(item.price)}" 
                     onchange="updateItemPrice(${colIndex}, ${secIndex}, ${itemIndex}, this.value)"
                     placeholder="Price">
            </div>
            <div class="item-controls">
              <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${colIndex}, ${secIndex}, ${itemIndex})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }

      // ==================== CRUD Operations ====================

      // Save state for undo
      function saveState() {
        undoStack.push(JSON.stringify(pageData));
        if (undoStack.length > 50) undoStack.shift();
        redoStack = [];
        hasUnsavedChanges = true;
        updateSaveStatus('Unsaved changes...');
      }

      // Add a new column
      window.addColumn = function(theme = 'light') {
        saveState();
        const newCol = {
          id: 'col-' + Date.now(),
          title: 'NEW COLUMN',
          theme: theme,
          sections: [{
            id: 'sec-' + Date.now(),
            name: 'NEW SECTION',
            subtitle: '',
            items: []
          }],
          footer: ''
        };
        pageData.columns.push(newCol);
        renderPageBuilder();
      };

      // Delete column
      window.deleteColumn = function(colIndex) {
        if (!confirm('Delete this entire column and all its contents?')) return;
        saveState();
        pageData.columns.splice(colIndex, 1);
        renderPageBuilder();
      };

      // Toggle column theme
      window.toggleColumnTheme = function(colIndex) {
        saveState();
        pageData.columns[colIndex].theme = pageData.columns[colIndex].theme === 'dark' ? 'light' : 'dark';
        renderPageBuilder();
      };

      // Update column title
      window.updateColumnTitle = function(colIndex, value) {
        saveState();
        pageData.columns[colIndex].title = value;
      };

      // Add section to column
      window.addSection = function(colIndex) {
        saveState();
        pageData.columns[colIndex].sections.push({
          id: 'sec-' + Date.now(),
          name: 'NEW SECTION',
          subtitle: '',
          items: []
        });
        renderPageBuilder();
      };

      // Delete section
      window.deleteSection = function(colIndex, secIndex) {
        if (!confirm('Delete this section and all its items?')) return;
        saveState();
        pageData.columns[colIndex].sections.splice(secIndex, 1);
        renderPageBuilder();
      };

      // Update section name
      window.updateSectionName = function(colIndex, secIndex, value) {
        saveState();
        pageData.columns[colIndex].sections[secIndex].name = value;
      };

      // Update section subtitle
      window.updateSectionSubtitle = function(colIndex, secIndex, value) {
        saveState();
        pageData.columns[colIndex].sections[secIndex].subtitle = value;
      };

      // Add item to section
      window.addItem = function(colIndex, secIndex) {
        saveState();
        pageData.columns[colIndex].sections[secIndex].items.push({
          id: 'item-' + Date.now(),
          name: 'New Service',
          price: '$0.00'
        });
        renderPageBuilder();
      };

      // Delete item
      window.deleteItem = function(colIndex, secIndex, itemIndex) {
        const item = pageData.columns[colIndex].sections[secIndex].items[itemIndex];
        if (!confirm(`Delete "${item.name}"?`)) return;
        saveState();
        pageData.columns[colIndex].sections[secIndex].items.splice(itemIndex, 1);
        renderPageBuilder();
      };

      // Update item name
      window.updateItemName = function(colIndex, secIndex, itemIndex, value) {
        saveState();
        pageData.columns[colIndex].sections[secIndex].items[itemIndex].name = value;
      };

      // Update item price
      window.updateItemPrice = function(colIndex, secIndex, itemIndex, value) {
        saveState();
        pageData.columns[colIndex].sections[secIndex].items[itemIndex].price = value;
      };

      // Move item up in list
      window.moveItemUp = function(colIndex, secIndex, itemIndex) {
        if (itemIndex === 0) return;
        saveState();
        const items = pageData.columns[colIndex].sections[secIndex].items;
        [items[itemIndex - 1], items[itemIndex]] = [items[itemIndex], items[itemIndex - 1]];
        renderPageBuilder();
      };

      // Move item down in list
      window.moveItemDown = function(colIndex, secIndex, itemIndex) {
        const items = pageData.columns[colIndex].sections[secIndex].items;
        if (itemIndex >= items.length - 1) return;
        saveState();
        [items[itemIndex], items[itemIndex + 1]] = [items[itemIndex + 1], items[itemIndex]];
        renderPageBuilder();
      };

      // Move section up
      window.moveSectionUp = function(colIndex, secIndex) {
        if (secIndex === 0) return;
        saveState();
        const sections = pageData.columns[colIndex].sections;
        [sections[secIndex - 1], sections[secIndex]] = [sections[secIndex], sections[secIndex - 1]];
        renderPageBuilder();
      };

      // Move section down
      window.moveSectionDown = function(colIndex, secIndex) {
        const sections = pageData.columns[colIndex].sections;
        if (secIndex >= sections.length - 1) return;
        saveState();
        [sections[secIndex], sections[secIndex + 1]] = [sections[secIndex + 1], sections[secIndex]];
        renderPageBuilder();
      };

      // Move column left
      window.moveColumnLeft = function(colIndex) {
        if (colIndex === 0) return;
        saveState();
        [pageData.columns[colIndex - 1], pageData.columns[colIndex]] = [pageData.columns[colIndex], pageData.columns[colIndex - 1]];
        renderPageBuilder();
      };

      // Move column right
      window.moveColumnRight = function(colIndex) {
        if (colIndex >= pageData.columns.length - 1) return;
        saveState();
        [pageData.columns[colIndex], pageData.columns[colIndex + 1]] = [pageData.columns[colIndex + 1], pageData.columns[colIndex]];
        renderPageBuilder();
      };

      // ==================== Drag and Drop ====================

      let draggedElement = null;
      let dragType = null;
      let dragData = null;

      function setupDragAndDrop() {
        // Column drag and drop
        const columns = document.querySelectorAll('.builder-column');
        const columnsContainer = document.getElementById('columns-container');
        
        columns.forEach(col => {
          col.addEventListener('dragstart', handleColumnDragStart);
          col.addEventListener('dragend', handleDragEnd);
          col.addEventListener('dragover', handleColumnDragOver);
          col.addEventListener('drop', handleColumnDrop);
        });

        // Item drag and drop - use the drag handle
        const items = document.querySelectorAll('.builder-item');
        
        items.forEach(item => {
          // Make the whole item draggable but only via the handle
          const handle = item.querySelector('.item-drag-handle');
          if (handle) {
            handle.addEventListener('mousedown', () => {
              item.setAttribute('draggable', 'true');
            });
            handle.addEventListener('mouseup', () => {
              item.setAttribute('draggable', 'false');
            });
          }
          
          item.addEventListener('dragstart', handleItemDragStart);
          item.addEventListener('dragend', handleDragEnd);
          item.addEventListener('dragover', handleItemDragOver);
          item.addEventListener('drop', handleItemDrop);
        });
        
        // Allow dropping on item containers (for empty sections)
        const itemContainers = document.querySelectorAll('.items-container');
        itemContainers.forEach(container => {
          container.addEventListener('dragover', handleContainerDragOver);
          container.addEventListener('drop', handleContainerDrop);
          container.addEventListener('dragleave', handleDragLeave);
        });
        
        // Section drag and drop
        const sections = document.querySelectorAll('.builder-section');
        
        sections.forEach(section => {
          section.addEventListener('dragstart', handleSectionDragStart);
          section.addEventListener('dragend', handleDragEnd);
          section.addEventListener('dragover', handleSectionDragOver);
          section.addEventListener('drop', handleSectionDrop);
        });
      }

      // ===== COLUMN DRAG =====
      function handleColumnDragStart(e) {
        // Don't drag if clicking on child elements like inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
          e.preventDefault();
          return;
        }
        draggedElement = this;
        dragType = 'column';
        dragData = {
          colIndex: parseInt(this.dataset.colIndex)
        };
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'column');
      }

      function handleColumnDragOver(e) {
        if (dragType !== 'column') return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const rect = this.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        
        // Show drop indicator
        this.classList.remove('drop-left', 'drop-right');
        if (e.clientX < midX) {
          this.classList.add('drop-left');
        } else {
          this.classList.add('drop-right');
        }
      }

      function handleColumnDrop(e) {
        e.preventDefault();
        if (dragType !== 'column') return;
        
        const targetColIndex = parseInt(this.dataset.colIndex);
        const sourceColIndex = dragData.colIndex;
        
        if (sourceColIndex === targetColIndex) return;
        
        // Determine insert position based on mouse position
        const rect = this.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        let insertIndex = e.clientX < midX ? targetColIndex : targetColIndex + 1;
        
        // Adjust if moving from before to after
        if (sourceColIndex < insertIndex) insertIndex--;
        
        saveState();
        
        // Remove and reinsert column
        const [column] = pageData.columns.splice(sourceColIndex, 1);
        pageData.columns.splice(insertIndex, 0, column);
        
        renderPageBuilder();
      }

      // ===== ITEM DRAG =====
      function handleItemDragStart(e) {
        e.stopPropagation(); // Prevent section/column drag
        draggedElement = this;
        dragType = 'item';
        dragData = {
          colIndex: parseInt(this.dataset.colIndex),
          secIndex: parseInt(this.dataset.secIndex),
          itemIndex: parseInt(this.dataset.itemIndex)
        };
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'item');
      }

      function handleItemDragOver(e) {
        if (dragType !== 'item') return;
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        
        // Show drop indicator above or below
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        this.classList.remove('drop-above', 'drop-below');
        if (e.clientY < midY) {
          this.classList.add('drop-above');
        } else {
          this.classList.add('drop-below');
        }
      }

      function handleItemDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        if (dragType !== 'item') return;
        
        this.classList.remove('drop-above', 'drop-below');
        
        const targetColIndex = parseInt(this.dataset.colIndex);
        const targetSecIndex = parseInt(this.dataset.secIndex);
        const targetItemIndex = parseInt(this.dataset.itemIndex);
        
        const { colIndex: srcColIndex, secIndex: srcSecIndex, itemIndex: srcItemIndex } = dragData;
        
        // Determine insert position
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        let insertIndex = e.clientY < midY ? targetItemIndex : targetItemIndex + 1;
        
        // Same section reordering
        if (srcColIndex === targetColIndex && srcSecIndex === targetSecIndex) {
          if (srcItemIndex === insertIndex || srcItemIndex + 1 === insertIndex) return;
          if (srcItemIndex < insertIndex) insertIndex--;
        }
        
        saveState();
        
        // Remove from source
        const [item] = pageData.columns[srcColIndex].sections[srcSecIndex].items.splice(srcItemIndex, 1);
        
        // Insert at target
        pageData.columns[targetColIndex].sections[targetSecIndex].items.splice(insertIndex, 0, item);
        
        renderPageBuilder();
      }

      function handleContainerDragOver(e) {
        if (dragType !== 'item') return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
      }

      function handleContainerDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        if (dragType !== 'item') return;
        
        // If dropped on container (not on an item), add to end
        const targetColIndex = parseInt(this.dataset.colIndex);
        const targetSecIndex = parseInt(this.dataset.secIndex);
        
        const { colIndex: srcColIndex, secIndex: srcSecIndex, itemIndex: srcItemIndex } = dragData;
        
        saveState();
        
        // Remove from source
        const [item] = pageData.columns[srcColIndex].sections[srcSecIndex].items.splice(srcItemIndex, 1);
        
        // Add to end of target
        pageData.columns[targetColIndex].sections[targetSecIndex].items.push(item);
        
        renderPageBuilder();
      }

      // ===== SECTION DRAG =====
      function handleSectionDragStart(e) {
        // Don't start if dragging from an item or input
        if (e.target.closest('.builder-item') || e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
          e.preventDefault();
          return;
        }
        e.stopPropagation();
        draggedElement = this;
        dragType = 'section';
        dragData = {
          colIndex: parseInt(this.dataset.colIndex),
          secIndex: parseInt(this.dataset.secIndex)
        };
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'section');
      }

      function handleSectionDragOver(e) {
        if (dragType !== 'section') return;
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        this.classList.remove('drop-above', 'drop-below');
        if (e.clientY < midY) {
          this.classList.add('drop-above');
        } else {
          this.classList.add('drop-below');
        }
      }

      function handleSectionDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        if (dragType !== 'section') return;
        
        this.classList.remove('drop-above', 'drop-below');
        
        const targetColIndex = parseInt(this.dataset.colIndex);
        const targetSecIndex = parseInt(this.dataset.secIndex);
        
        const { colIndex: srcColIndex, secIndex: srcSecIndex } = dragData;
        
        // Determine insert position
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        let insertIndex = e.clientY < midY ? targetSecIndex : targetSecIndex + 1;
        
        // Same column reordering
        if (srcColIndex === targetColIndex) {
          if (srcSecIndex === insertIndex || srcSecIndex + 1 === insertIndex) return;
          if (srcSecIndex < insertIndex) insertIndex--;
        }
        
        saveState();
        
        // Remove from source
        const [section] = pageData.columns[srcColIndex].sections.splice(srcSecIndex, 1);
        
        // Insert at target
        pageData.columns[targetColIndex].sections.splice(insertIndex, 0, section);
        
        renderPageBuilder();
      }

      // ===== COMMON HANDLERS =====
      function handleDragEnd() {
        this.classList.remove('dragging');
        this.setAttribute('draggable', 'false');
        document.querySelectorAll('.drag-over, .drop-above, .drop-below, .drop-left, .drop-right').forEach(el => {
          el.classList.remove('drag-over', 'drop-above', 'drop-below', 'drop-left', 'drop-right');
        });
        draggedElement = null;
        dragType = null;
        dragData = null;
      }

      function handleDragLeave(e) {
        this.classList.remove('drag-over', 'drop-above', 'drop-below');
      }

      // ==================== Undo/Redo ====================

      window.undoChange = function() {
        if (undoStack.length === 0) return;
        redoStack.push(JSON.stringify(pageData));
        pageData = JSON.parse(undoStack.pop());
        renderPageBuilder();
        updateSaveStatus('Unsaved changes...');
      };

      window.redoChange = function() {
        if (redoStack.length === 0) return;
        undoStack.push(JSON.stringify(pageData));
        pageData = JSON.parse(redoStack.pop());
        renderPageBuilder();
        updateSaveStatus('Unsaved changes...');
      };

      // ==================== Preview Mode ====================

      window.togglePreviewMode = function() {
        isPreviewMode = !isPreviewMode;
        const canvas = document.getElementById('builder-canvas');
        const btn = document.getElementById('preview-toggle');
        
        if (isPreviewMode) {
          canvas.classList.add('preview-mode');
          btn.innerHTML = '<i class="fas fa-edit"></i> Edit';
          btn.classList.add('active');
        } else {
          canvas.classList.remove('preview-mode');
          btn.innerHTML = '<i class="fas fa-eye"></i> Preview';
          btn.classList.remove('active');
        }
      };

      // ==================== Save to Firebase ====================

      window.saveAllPrices = async function() {
        try {
          document.getElementById('loading-spinner').style.display = 'block';
          updateSaveStatus('Saving...');
          
          // Update header from inputs
          pageData.header.line1 = document.getElementById('header-line1').value;
          pageData.header.line2 = document.getElementById('header-line2').value;
          
          // Save the page structure
          await db.collection('pricing_page').doc('structure').set(pageData);
          
          // Also update the pricing_services collection for backward compatibility
          const batch = db.batch();
          
          // Collect all items with their categories
          const allItems = [];
          pageData.columns.forEach(col => {
            const category = col.title.includes('OIL') ? 'Oil' : 
                           col.title.includes('BRAKE') ? 'Brakes' : 
                           col.title.includes('TIRE') ? 'Tires' : 'General';
            col.sections.forEach(sec => {
              sec.items.forEach(item => {
                allItems.push({
                  id: item.id,
                  name: item.name,
                  price: item.price,
                  category: category,
                  sectionName: sec.name,
                  sectionSubtitle: sec.subtitle
                });
              });
            });
          });
          
          // Update each item in pricing_services
          for (const item of allItems) {
            if (item.id && !item.id.startsWith('item-')) {
              // Existing item - update
              const ref = db.collection('pricing_services').doc(item.id);
              batch.update(ref, {
                name: item.name,
                price: item.price,
                category: item.category
              });
            } else {
              // New item - create
              const ref = db.collection('pricing_services').doc();
              batch.set(ref, {
                name: item.name,
                price: item.price,
                category: item.category
              });
              // Update local ID
              item.id = ref.id;
            }
          }
          
          await batch.commit();
          
          hasUnsavedChanges = false;
          updateSaveStatus('All changes saved!', true);
          
        } catch (error) {
          console.error('Error saving:', error);
          alert('Error saving: ' + error.message);
          updateSaveStatus('Error saving!');
        } finally {
          document.getElementById('loading-spinner').style.display = 'none';
        }
      };

      // Update save status
      function updateSaveStatus(message, isSuccess = false) {
        const statusEl = document.getElementById('save-status');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.className = isSuccess ? 'text-success' : 'text-warning';
        }
      }

      // Load on pricing tab show
      function loadVisualPricing() {
        initPageBuilder();
      }

      // Legacy load services (for table view)
      function loadServices() {
        loadVisualPricing();
      }

      function renderServicesTable(services) {
        const tbody = document.getElementById('services-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        services.sort((a, b) => a.name.localeCompare(b.name));

        services.forEach((data) => {
          const row = `
            <tr>
              <td class="fw-bold">${data.name}</td>
              <td>${data.price}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editService('${data.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteService('${data.id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // Save Service (from modal)
      document.getElementById('save-service-btn').addEventListener('click', () => {
        const id = document.getElementById('service-id').value;
        const name = document.getElementById('service-name').value;
        const price = document.getElementById('service-price').value;
        const category = document.getElementById('service-category').value;

        const data = { name, price, category };

        if (id) {
          db.collection('pricing_services').doc(id).update(data).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
            loadVisualPricing();
          });
        } else {
          db.collection('pricing_services').add(data).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
            loadVisualPricing();
          });
        }
      });

      // Clear modal when opened for new service
      document.getElementById('addServiceModal').addEventListener('show.bs.modal', function (event) {
        if (!document.getElementById('service-id').value) {
          document.getElementById('service-name').value = '';
          document.getElementById('service-price').value = '';
          document.getElementById('service-category').value = 'Oil';
        }
      });

      // Delete Service
      window.deleteService = (id) => {
        if (confirm('Are you sure you want to delete this service?')) {
          db.collection('pricing_services').doc(id).delete().then(() => loadVisualPricing());
        }
      };

      // Edit Service
      window.editService = (id) => {
        const service = allServices.find((s) => s.id === id);
        if (service) {
          document.getElementById('service-id').value = id;
          document.getElementById('service-name').value = service.name;
          document.getElementById('service-price').value = service.price;
          document.getElementById('service-category').value = service.category || 'General';
          new bootstrap.Modal(document.getElementById('addServiceModal')).show();
        }
      };

      // Reset to Defaults
      window.resetToDefaults = () => {
        if (!confirm('DANGER: This will delete ALL Services from the Database.\nThe website will revert to its original static HTML styling.\nAre you sure?')) return;

        document.getElementById('loading-spinner').style.display = 'block';

        db.collection('pricing_services').get().then((snapshot) => {
          const batch = db.batch();
          snapshot.docs.forEach((doc) => batch.delete(doc.ref));
          return batch.commit();
        }).then(() => {
          alert('Database Cleared. Website will now use default static HTML.');
          loadVisualPricing();
        }).catch((err) => {
          alert('Error: ' + err.message);
          document.getElementById('loading-spinner').style.display = 'none';
        });
      };

      // Re-Import Defaults
      window.reimportDefaults = () => {
        if (!confirm('This will DELETE all current data and re-import defaults.\nContinue?')) return;

        document.getElementById('loading-spinner').style.display = 'block';

        db.collection('pricing_services').get().then((snapshot) => {
          const batch = db.batch();
          snapshot.docs.forEach((doc) => batch.delete(doc.ref));
          return batch.commit();
        }).then(() => importServices(true));
      };

      // Import Services (with updated defaults matching the image)
      async function importServices(auto = false) {
        try {
          const defaultServices = [
            // Oil Column
            { name: 'MOBIL 1', price: '$123.97 10k/Mi', category: 'Oil' },
            { name: 'MOBIL SUPER', price: '$104.02 7k/Mi', category: 'Oil' },
            { name: 'DELVAC 1 5w40', price: '$188.40 10K/Mi', category: 'Oil' },
            { name: 'ROTELLA', price: '$188.40 5K/Mi', category: 'Oil' },
            { name: 'WIPER BLADES', price: '17.37/PC', category: 'Oil' },
            // Brakes Column
            { name: 'Cars/Suv', price: '$229.71*', category: 'Brakes' },
            { name: 'Heavy Duty', price: '$297.82*', category: 'Brakes' },
            // Tires Column
            { name: 'TIRE REPAIR', price: '$19.90 - $64.32', category: 'Tires' },
            { name: 'TIRE ROTATION / RELEARN', price: '$44.19', category: 'Tires' },
            { name: 'ROTATE & BALANCE', price: '$58.82', category: 'Tires' },
            { name: '33+TIRE ROTATION', price: '$48.61', category: 'Tires' },
            { name: '33+ROTATE&BALANCE', price: '$99.44', category: 'Tires' },
            { name: 'TPMS RELEARN', price: '$33.14', category: 'Tires' },
            { name: 'MOUNT/BALANCE', price: '$38.66/Tire', category: 'Tires' },
            { name: 'OVERSIZED', price: '$55.37/Tire', category: 'Tires' },
            { name: 'TPMS SENSOR', price: '$77.33', category: 'Tires' },
          ];

          const batch = db.batch();
          defaultServices.forEach((service) => {
            const newRef = db.collection('pricing_services').doc();
            batch.set(newRef, service);
          });

          await batch.commit();
          alert(`Successfully added ${defaultServices.length} default services!`);
          loadVisualPricing();
        } catch (e) {
          console.error('Error importing:', e);
          alert('Error importing: ' + e.message);
        }
      }

      // Warn before leaving with unsaved changes
      window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '';
        }
      });

      // ==================== UTILITY FUNCTIONS ====================

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // ==================== INSPECTION RESULTS FUNCTIONS ====================

      // Inspection item labels mapping (from the self-check form)
      const inspectionLabels = {
        'dashboard_warning_lights': 'Dashboard Warning Lights',
        'battery_corrosion': 'Battery Condition',
        'coolant_low': 'Coolant Level',
        'tire_wear': 'Tire Condition',
        'tire_pressure': 'Tire Pressure',
        'brake_pads': 'Brake Pads',
        'brake_fluid': 'Brake Fluid',
        'wiper_blades': 'Wiper Blades',
        'headlights': 'Headlights',
        'taillights': 'Taillights',
        'turn_signals': 'Turn Signals',
        'oil_level': 'Oil Level',
        'transmission_fluid': 'Transmission Fluid',
        'power_steering': 'Power Steering Fluid',
        'air_filter': 'Air Filter',
        'cabin_filter': 'Cabin Air Filter',
        'belts': 'Belts',
        'hoses': 'Hoses',
        'exhaust': 'Exhaust System',
        'suspension': 'Suspension',
        'steering': 'Steering',
        'fluid_leak': 'Fluid Leaks',
        'unusual_sounds': 'Unusual Sounds',
        'vibration': 'Vibrations'
      };

      // Render inspection preview (condensed view for submission card)
      function renderInspectionPreview(sub) {
        if (!sub.items || typeof sub.items !== 'object') return '';
        
        const items = sub.items;
        const itemKeys = Object.keys(items);
        if (itemKeys.length === 0) return '';
        
        // Count by status
        let goodCount = 0, warningCount = 0, badCount = 0;
        itemKeys.forEach(key => {
          const state = items[key]?.state;
          if (state === 'good') goodCount++;
          else if (state === 'warning') warningCount++;
          else if (state === 'bad') badCount++;
        });
        
        // Get items with issues (warning or bad)
        const issueItems = itemKeys.filter(key => 
          items[key]?.state === 'warning' || items[key]?.state === 'bad'
        ).slice(0, 3);
        
        let html = `
          <div class="inspection-results">
            <div class="inspection-results-title">
              <i class="fas fa-clipboard-check me-1"></i>Self-Inspection Summary
            </div>
        `;
        
        if (issueItems.length > 0) {
          html += `<div style="font-size:13px;color:#495057;margin-bottom:8px;">Issues flagged:</div>`;
          issueItems.forEach(key => {
            const item = items[key];
            const label = inspectionLabels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const iconClass = item.state === 'bad' ? 'bad' : 'warning';
            const icon = item.state === 'bad' ? 'fa-times-circle' : 'fa-exclamation-triangle';
            html += `
              <div class="inspection-item">
                <div class="inspection-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                <div class="inspection-label">${escapeHtml(label)}</div>
              </div>
            `;
          });
          if (itemKeys.filter(key => items[key]?.state === 'warning' || items[key]?.state === 'bad').length > 3) {
            html += `<div style="font-size:12px;color:#6c757d;margin-top:5px;">+ more issues found...</div>`;
          }
        }
        
        html += `
          <div class="inspection-summary">
            <span class="inspection-summary-item">
              <i class="fas fa-check-circle text-success"></i> ${goodCount} Good
            </span>
            <span class="inspection-summary-item">
              <i class="fas fa-exclamation-triangle text-warning"></i> ${warningCount} Warning
            </span>
            <span class="inspection-summary-item">
              <i class="fas fa-times-circle text-danger"></i> ${badCount} Needs Attention
            </span>
          </div>
        </div>`;
        
        return html;
      }

      // View full inspection results
      function viewInspectionResults(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub || !sub.items) return;

        // Mark as read
        markAsRead(id);

        const content = document.getElementById('inspection-results-content');
        const items = sub.items;
        const itemKeys = Object.keys(items);
        
        // Customer info - handle wpforms bracket notation
        const name = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || 'Customer';
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';
        const vehicle = sub.vehicle || sub['wpforms[fields][7]'] || '';
        const subDate = getSubmissionDate(sub);
        const date = subDate ? subDate.toLocaleString() : 'Unknown';
        
        let html = `
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Customer Information</h6>
              <p class="mb-1"><strong>Name:</strong> ${escapeHtml(name)}</p>
              ${email ? `<p class="mb-1"><strong>Email:</strong> <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a></p>` : ''}
              ${phone ? `<p class="mb-1"><strong>Phone:</strong> <a href="tel:${escapeHtml(phone)}">${escapeHtml(phone)}</a></p>` : ''}
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Vehicle & Date</h6>
              ${vehicle ? `<p class="mb-1"><strong>Vehicle:</strong> ${escapeHtml(vehicle)}</p>` : ''}
              <p class="mb-1"><strong>Submitted:</strong> ${escapeHtml(date)}</p>
            </div>
          </div>
          
          <hr>
          
          <h6 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Inspection Results</h6>
          <div class="row">
        `;
        
        // Group items by status
        const goodItems = [], warningItems = [], badItems = [];
        itemKeys.forEach(key => {
          const item = items[key];
          if (item.state === 'good') goodItems.push({ key, ...item });
          else if (item.state === 'warning') warningItems.push({ key, ...item });
          else if (item.state === 'bad') badItems.push({ key, ...item });
        });
        
        // Render issues first (bad + warning)
        if (badItems.length > 0 || warningItems.length > 0) {
          html += `<div class="col-12 mb-3">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>Items Needing Attention (${badItems.length + warningItems.length})
              </div>
              <div class="card-body">`;
          
          [...badItems, ...warningItems].forEach(item => {
            const label = inspectionLabels[item.key] || item.key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const iconClass = item.state === 'bad' ? 'text-danger' : 'text-warning';
            const icon = item.state === 'bad' ? 'fa-times-circle' : 'fa-exclamation-triangle';
            
            html += `
              <div class="mb-3 pb-3 border-bottom">
                <div class="d-flex align-items-center">
                  <i class="fas ${icon} ${iconClass} me-2" style="font-size:18px;"></i>
                  <strong>${escapeHtml(label)}</strong>
                  <span class="badge ${item.state === 'bad' ? 'bg-danger' : 'bg-warning text-dark'} ms-2">
                    ${item.state === 'bad' ? 'Needs Attention' : 'Warning'}
                  </span>
                </div>
                ${item.notes ? `<p class="mb-1 mt-2 text-muted"><i class="fas fa-sticky-note me-1"></i>${escapeHtml(item.notes)}</p>` : ''}
                ${renderExtraData(item.extraData)}
              </div>
            `;
          });
          
          html += `</div></div></div>`;
        }
        
        // Render good items
        if (goodItems.length > 0) {
          html += `<div class="col-12">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>Items in Good Condition (${goodItems.length})
              </div>
              <div class="card-body">
                <div class="row">`;
          
          goodItems.forEach(item => {
            const label = inspectionLabels[item.key] || item.key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `
              <div class="col-md-4 col-sm-6 mb-2">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle text-success me-2"></i>
                  <span>${escapeHtml(label)}</span>
                </div>
                ${item.notes ? `<small class="text-muted ms-4">${escapeHtml(item.notes)}</small>` : ''}
              </div>
            `;
          });
          
          html += `</div></div></div></div>`;
        }
        
        html += `</div>`;
        
        // Appointment request info
        if (sub.appointment_request) {
          html += `
            <hr>
            <div class="alert alert-info">
              <i class="fas fa-calendar-check me-2"></i>
              <strong>Appointment Requested:</strong> Customer wants to schedule a professional inspection.
              ${sub.appointment_comments ? `<br><small>${escapeHtml(sub.appointment_comments)}</small>` : ''}
            </div>
          `;
        }

        content.innerHTML = html;
        new bootstrap.Modal(document.getElementById('inspectionResultsModal')).show();
      }

      // Render extra data from inspection items
      function renderExtraData(extraData) {
        if (!extraData || typeof extraData !== 'object') return '';
        
        const entries = Object.entries(extraData).filter(([k, v]) => v && v !== 'I am unsure');
        if (entries.length === 0) return '';
        
        let html = '<div class="mt-2 ms-4 p-2 bg-light rounded">';
        entries.forEach(([key, value]) => {
          // Format key nicely
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          
          if (Array.isArray(value)) {
            // Handle arrays (like selected warning lights)
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong></small>`;
            if (value.length > 0) {
              html += '<ul class="mb-0 ms-3">';
              value.forEach(v => {
                if (typeof v === 'object' && v.name) {
                  html += `<li><small>${escapeHtml(v.name)}</small></li>`;
                } else {
                  html += `<li><small>${escapeHtml(String(v))}</small></li>`;
                }
              });
              html += '</ul>';
            }
            html += '</div>';
          } else if (typeof value === 'object') {
            // Handle nested objects
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong> ${escapeHtml(JSON.stringify(value))}</small></div>`;
          } else {
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong> ${escapeHtml(String(value))}</small></div>`;
          }
        });
        html += '</div>';
        
        return html;
      }

      // Print inspection results
      function printInspectionResults() {
        const content = document.getElementById('inspection-results-content').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Vehicle Inspection Report - Quality Lube Express</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
              body { padding: 20px; font-size: 14px; }
              @media print { .no-print { display: none; } }
            </style>
          </head>
          <body>
            <div class="text-center mb-4">
              <h3>Quality Lube Express</h3>
              <p class="text-muted">Vehicle Self-Inspection Report</p>
            </div>
            ${content}
            <script>window.print(); setTimeout(() => window.close(), 500);<\/script>
          </body>
          </html>
        `);
      }
    </script>
  </body>
</html>
