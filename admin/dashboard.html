<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Quality Lube Express</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
      body {
        background-color: #f5f5f5;
        font-family: "Roboto", "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      .l-header {
        background: #000;
        color: #fff;
        padding: 10px 0;
      }
      .l-subheader-h {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }
      .admin-brand {
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        text-decoration: none;
      }
      .dashboard-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      }
      
      /* Override Bootstrap conflicts */
      a { text-decoration: none; }
      
      /* Tab Navigation */
      .nav-tabs .nav-link {
        color: #666;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        font-weight: 500;
      }
      .nav-tabs .nav-link:hover {
        border-color: #ddd;
        color: #333;
      }
      .nav-tabs .nav-link.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
        background: transparent;
      }
      
      /* Submission Cards */
      .submission-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        background: #fff;
        transition: all 0.2s ease;
      }
      .submission-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .submission-card.unread {
        border-left: 4px solid #0066cc;
        background: #f8faff;
      }
      .submission-card.read {
        border-left: 4px solid #28a745;
      }
      .submission-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      .submission-meta {
        font-size: 12px;
        color: #888;
      }
      .submission-type {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .submission-type.contact { background: #e3f2fd; color: #1976d2; }
      .submission-type.appointment { background: #fff3e0; color: #f57c00; }
      .submission-type.careers { background: #ede7f6; color: #7b1fa2; }
      .submission-type.self_check { background: #e8f5e9; color: #388e3c; }
      .submission-type.lead_capture_start { background: #fce4ec; color: #c2185b; }

      /* Inspection Results Styling */
      .inspection-results {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
      }
      .inspection-results-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
        color: #495057;
      }
      .inspection-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 13px;
      }
      .inspection-item:last-child {
        border-bottom: none;
      }
      .inspection-icon {
        width: 20px;
        text-align: center;
        flex-shrink: 0;
      }
      .inspection-icon.good { color: #28a745; }
      .inspection-icon.warning { color: #ffc107; }
      .inspection-icon.bad { color: #dc3545; }
      .inspection-label {
        flex: 1;
        color: #495057;
      }
      .inspection-notes {
        font-size: 12px;
        color: #6c757d;
        margin-left: 28px;
        font-style: italic;
      }
      .inspection-extra {
        font-size: 12px;
        color: #6c757d;
        margin-left: 28px;
        background: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        margin-top: 4px;
      }
      .inspection-summary {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        font-size: 13px;
      }
      .inspection-summary-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      /* Group Headers */
      .group-header {
        padding: 12px 15px;
        margin: 20px 0 10px 0;
        font-weight: 600;
        border-radius: 6px;
      }
      .group-header:first-child {
        margin-top: 0;
      }
      .date-header {
        background: #e3f2fd;
        color: #1565c0;
        font-size: 16px;
      }
      .type-header {
        background: #f3e5f5;
        color: #7b1fa2;
        font-size: 16px;
      }
      .type-subheader {
        background: #f5f5f5;
        color: #666;
        font-size: 14px;
        margin-left: 20px;
        margin-right: 0;
      }
      
      .submission-contact {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .submission-contact-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }
      .submission-contact-item i {
        color: #666;
        width: 16px;
      }
      .submission-contact-item a {
        color: #0066cc;
        text-decoration: none;
      }
      .submission-contact-item a:hover {
        text-decoration: underline;
      }
      
      .submission-message {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      
      .submission-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      
      /* Filter Bar */
      .filter-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
      }
      .filter-bar select, .filter-bar input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      /* Stats Bar */
      .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .stat-item {
        background: #f5f5f5;
        padding: 15px 25px;
        border-radius: 8px;
        text-align: center;
        min-width: 100px;
      }
      .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #0066cc;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }
      
      /* Live indicator */
      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #e8f5e9;
        border-radius: 20px;
        font-size: 12px;
        color: #388e3c;
      }
      .live-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      /* Quick Reply Modal */
      .quick-reply-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }
      .quick-reply-btn {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        text-align: left;
        font-size: 13px;
        transition: all 0.2s;
      }
      .quick-reply-btn:hover {
        border-color: #0066cc;
        background: #fff;
      }
      .quick-reply-btn i {
        margin-right: 8px;
        color: #0066cc;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #ddd;
      }
      
      /* Form Switch Toggles */
      .form-check.form-switch {
        padding-left: 2.5em;
        min-height: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .form-check.form-switch .form-check-input {
        width: 2em;
        height: 1em;
        margin-left: -2.5em;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%280, 0, 0, 0.25%29'/%3e%3c/svg%3e");
        background-position: left center;
        border-radius: 2em;
        transition: background-position .15s ease-in-out;
        cursor: pointer;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
        appearance: none;
        -webkit-appearance: none;
      }
      .form-check.form-switch .form-check-input:checked {
        background-position: right center;
        background-color: #0d6efd;
        border-color: #0d6efd;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
      }
      .form-check.form-switch .form-check-input:focus {
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      .form-check-label {
        cursor: pointer;
      }
      
      @media (max-width: 768px) {
        .filter-bar { flex-direction: column; align-items: stretch; }
        .stats-bar { justify-content: center; }
        .submission-header { flex-direction: column; gap: 10px; }
        .quick-reply-options { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="l-header">
      <div class="l-subheader at_middle">
        <div class="l-subheader-h">
          <div class="l-subheader-cell">
            <a href="../" class="admin-brand">
              <img src="../assets/img/logo-01.png" alt="Quality Lube" style="height: 60px" />
              <span style="margin-left: 15px; vertical-align: middle">Admin Portal</span>
            </a>
          </div>
          <div class="l-subheader-cell">
            <button class="btn btn-outline-light btn-sm" id="logout-btn">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="container dashboard-container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 style="margin: 0">Admin Dashboard</h2>
        <div class="d-flex align-items-center gap-3">
          <span class="live-indicator">Live Updates</span>
          <span class="badge bg-success" id="connection-status">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-4" id="dashboardTabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#submissions-tab">
            <i class="fas fa-inbox me-2"></i>Form Submissions
            <span class="badge bg-danger ms-2" id="unread-count" style="display:none;">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#pricing-tab">
            <i class="fas fa-dollar-sign me-2"></i>Pricing Management
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#settings-tab">
            <i class="fas fa-cog me-2"></i>Settings
          </a>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Submissions Tab -->
        <div class="tab-pane fade show active" id="submissions-tab">
          <!-- Stats Bar -->
          <div class="stats-bar">
            <div class="stat-item">
              <div class="stat-number" id="stat-total">0</div>
              <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-unread">0</div>
              <div class="stat-label">Unread</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-today">0</div>
              <div class="stat-label">Today</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="stat-appointments">0</div>
              <div class="stat-label">Appointments</div>
            </div>
          </div>

          <!-- Filter Bar -->
          <div class="filter-bar">
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Type</label>
              <select id="filter-type" class="form-select form-select-sm">
                <option value="">All Types</option>
                <option value="contact">Contact</option>
                <option value="appointment">Appointment</option>
                <option value="appointment_only">Appointment Only</option>
                <option value="self_check">Self-Check</option>
                <option value="lead_capture_start">Lead Capture</option>
                <option value="careers">Careers</option>
                <option value="quote">Quote Request</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Status</label>
              <select id="filter-status" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="unread">Unread</option>
                <option value="read">Read</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Date Range</label>
              <select id="filter-date" class="form-select form-select-sm">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Group By</label>
              <select id="filter-group" class="form-select form-select-sm">
                <option value="">No Grouping</option>
                <option value="date">Date</option>
                <option value="type">Type</option>
                <option value="date-type">Date then Type</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1" style="font-size:12px;">Search</label>
              <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Name, email, phone...">
            </div>
            <div class="ms-auto d-flex gap-2 align-items-end">
              <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="fas fa-times"></i> Clear
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="exportSubmissions()">
                <i class="fas fa-download"></i> Export CSV
              </button>
            </div>
          </div>

          <!-- Submissions List -->
          <div id="submissions-list">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing Tab -->
        <div class="tab-pane fade" id="pricing-tab">
          <div class="mb-4 d-flex gap-2 flex-wrap">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
              <i class="fas fa-plus"></i> Add New Service
            </button>
            <button class="btn btn-secondary" onclick="loadServices()">
              <i class="fas fa-sync"></i> Refresh
            </button>
            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-warning text-dark" onclick="reimportDefaults()">
                <i class="fas fa-history"></i> Reset Data & Imports
              </button>
              <button class="btn btn-danger" onclick="resetToDefaults()">
                <i class="fas fa-ban"></i> Disable Dynamic/Revert Styling
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th style="width: 50%">Service Name</th>
                  <th>Price</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="services-table-body">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>

          <div id="loading-spinner" class="text-center my-5" style="display:none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings-tab">
          <div class="card">
            <div class="card-body">
              <h5>Dashboard Settings</h5>
              <hr>
              <h6>Notification Settings</h6>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="sound-notifications" checked>
                <label class="form-check-label" for="sound-notifications">Play sound for new submissions</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="browser-notifications">
                <label class="form-check-label" for="browser-notifications">Browser notifications</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Reply Modal -->
    <div class="modal fade" id="quickReplyModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-reply me-2"></i>Quick Reply</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">To:</label>
              <input type="text" class="form-control" id="reply-to" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Quick Templates:</label>
              <div class="quick-reply-options">
                <button class="quick-reply-btn" onclick="useTemplate('appointment_confirm')">
                  <i class="fas fa-calendar-check"></i>Confirm Appointment
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('callback')">
                  <i class="fas fa-phone"></i>Will Call Back
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('quote')">
                  <i class="fas fa-file-invoice-dollar"></i>Quote/Estimate
                </button>
                <button class="quick-reply-btn" onclick="useTemplate('thank_you')">
                  <i class="fas fa-heart"></i>Thank You
                </button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Message:</label>
              <textarea class="form-control" id="reply-message" rows="6"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <a href="#" class="btn btn-success" id="send-email-btn">
              <i class="fas fa-envelope me-2"></i>Open in Email
            </a>
            <a href="#" class="btn btn-primary" id="send-sms-btn">
              <i class="fas fa-sms me-2"></i>Open in SMS
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="viewDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Submission Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="details-content">
            <!-- Content loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inspection Results Modal -->
    <div class="modal fade" id="inspectionResultsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-light">
            <h5 class="modal-title"><i class="fas fa-clipboard-check me-2 text-success"></i>Vehicle Self-Inspection Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="inspection-results-content">
            <!-- Content loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" onclick="printInspectionResults()">
              <i class="fas fa-print me-1"></i>Print Report
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Service Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="service-form">
              <input type="hidden" id="service-id" />
              <div class="mb-3">
                <label class="form-label">Service Name</label>
                <input type="text" class="form-control" id="service-name" required placeholder="e.g. Mobil 1" />
              </div>
              <div class="mb-3">
                <label class="form-label">Price / Description</label>
                <input type="text" class="form-control" id="service-price" required placeholder="e.g. $89.99" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-service-btn">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notification-sound" preload="auto">
      <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+PfXFxgI2Xk4N0bXOAipOOgXRvcX2Ii4mAdnBxe4SGhH53c3R7gIKAfXl3d3t+f358enl5e31+fXx7e3t8fX19fHt7e3x9fX18fHx8fX19fXx8fH19fX19fHx9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fHx8fH19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fQ==" type="audio/wav">
    </audio>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyA2DI7LRK4kR7DZtGRridtmCZYl8F32cLg",
        authDomain: "qualityexpress-c19f2.firebaseapp.com",
        projectId: "qualityexpress-c19f2",
        storageBucket: "qualityexpress-c19f2.firebasestorage.app",
        messagingSenderId: "201962327491",
        appId: "1:201962327491:web:342d771b9013d901cc8176",
        measurementId: "G-HJDBXM5CLX",
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let allSubmissions = [];
      let allServices = [];
      let unsubscribe = null;
      let currentReplyData = null;

      // Auth Guard
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../login.html';
        } else {
          initLiveSubmissions();
          loadServices();
          requestNotificationPermission();
        }
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        if (unsubscribe) unsubscribe();
        auth.signOut().then(() => (window.location.href = '../index.html'));
      });

      // Request notification permission
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
          document.getElementById('browser-notifications').addEventListener('change', function() {
            if (this.checked) {
              Notification.requestPermission();
            }
          });
        }
      }

      // ==================== FORM SUBMISSIONS ====================

      // Initialize real-time listener for form submissions
      function initLiveSubmissions() {
        // Real-time listener - fetch all and sort client-side to avoid index requirements
        unsubscribe = db.collection('form_submissions')
          .limit(500)
          .onSnapshot((snapshot) => {
            const previousCount = allSubmissions.length;
            allSubmissions = [];
            snapshot.forEach((doc) => {
              allSubmissions.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by timestamp/date descending (client-side)
            allSubmissions.sort((a, b) => {
              const dateA = a.timestamp || a.date ? new Date(a.timestamp || a.date) : new Date(0);
              const dateB = b.timestamp || b.date ? new Date(b.timestamp || b.date) : new Date(0);
              return dateB - dateA;
            });
            
            // Check for new submissions
            if (previousCount > 0 && allSubmissions.length > previousCount) {
              playNotificationSound();
              showBrowserNotification(allSubmissions[0]);
            }
            
            updateStats();
            renderSubmissions();
          }, (error) => {
            console.error('Error listening to submissions:', error);
            document.getElementById('submissions-list').innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error loading submissions: ${error.message}
              </div>
            `;
          });
      }

      // Play notification sound
      function playNotificationSound() {
        if (document.getElementById('sound-notifications')?.checked) {
          const audio = document.getElementById('notification-sound');
          audio.currentTime = 0;
          audio.play().catch(() => {});
        }
      }

      // Show browser notification
      function showBrowserNotification(submission) {
        if (document.getElementById('browser-notifications')?.checked && 
            'Notification' in window && 
            Notification.permission === 'granted') {
          const name = submission.name || submission.first_name || 'Someone';
          new Notification('New Form Submission', {
            body: `${name} submitted a ${submission.form_type || 'contact'} form`,
            icon: '../assets/img/logo-01.png'
          });
        }
      }

      // Get submission date (handles both 'timestamp' and 'date' fields)
      function getSubmissionDate(sub) {
        const dateStr = sub.timestamp || sub.date;
        return dateStr ? new Date(dateStr) : null;
      }

      // Update statistics
      function updateStats() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        const total = allSubmissions.length;
        const unread = allSubmissions.filter(s => !s.read).length;
        const todayCount = allSubmissions.filter(s => {
          const subDate = getSubmissionDate(s);
          return subDate && subDate >= today;
        }).length;
        const appointments = allSubmissions.filter(s => 
          s.form_type === 'appointment' || s.appointment_request
        ).length;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-unread').textContent = unread;
        document.getElementById('stat-today').textContent = todayCount;
        document.getElementById('stat-appointments').textContent = appointments;

        // Update unread badge
        const badge = document.getElementById('unread-count');
        if (unread > 0) {
          badge.textContent = unread;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }

      // Render submissions with filters
      function renderSubmissions() {
        const container = document.getElementById('submissions-list');
        
        // Apply filters
        let filtered = [...allSubmissions];
        
        const typeFilter = document.getElementById('filter-type').value;
        const statusFilter = document.getElementById('filter-status').value;
        const dateFilter = document.getElementById('filter-date').value;
        const searchFilter = document.getElementById('filter-search').value.toLowerCase();

        if (typeFilter) {
          filtered = filtered.filter(s => getFormType(s) === typeFilter);
        }

        if (statusFilter === 'unread') {
          filtered = filtered.filter(s => !s.read);
        } else if (statusFilter === 'read') {
          filtered = filtered.filter(s => s.read);
        }

        if (dateFilter) {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          let startDate;
          
          if (dateFilter === 'today') {
            startDate = today;
          } else if (dateFilter === 'week') {
            startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 7);
          } else if (dateFilter === 'month') {
            startDate = new Date(today);
            startDate.setMonth(startDate.getMonth() - 1);
          }
          
          if (startDate) {
            filtered = filtered.filter(s => {
              const subDate = getSubmissionDate(s);
              return subDate && subDate >= startDate;
            });
          }
        }

        if (searchFilter) {
          filtered = filtered.filter(s => {
            const searchStr = [
              s.name, s.email, s.phone, s.message, s.form_name, s.vehicle,
              s['wpforms[fields][1][first]'], s['wpforms[fields][1][last]'],
              s['wpforms[fields][3]'], s['wpforms[fields][4]'], s['wpforms[fields][5]'],
              s.raw_data
            ].filter(Boolean).join(' ').toLowerCase();
            return searchStr.includes(searchFilter);
          });
        }

        if (filtered.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h5>No Submissions Found</h5>
              <p>No form submissions match your current filters.</p>
            </div>
          `;
          return;
        }

        // Apply grouping
        const groupBy = document.getElementById('filter-group').value;
        
        if (!groupBy) {
          container.innerHTML = filtered.map(sub => renderSubmissionCard(sub)).join('');
        } else {
          container.innerHTML = renderGroupedSubmissions(filtered, groupBy);
        }
      }

      // Render grouped submissions
      function renderGroupedSubmissions(submissions, groupBy) {
        let html = '';
        
        if (groupBy === 'date' || groupBy === 'date-type') {
          // Group by date first
          const byDate = {};
          submissions.forEach(sub => {
            const date = getSubmissionDate(sub);
            const dateKey = date ? date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Unknown Date';
            if (!byDate[dateKey]) byDate[dateKey] = [];
            byDate[dateKey].push(sub);
          });
          
          for (const [dateKey, dateSubs] of Object.entries(byDate)) {
            if (groupBy === 'date-type') {
              // Further group by type within each date
              const byType = {};
              dateSubs.forEach(sub => {
                const type = getFormType(sub);
                if (!byType[type]) byType[type] = [];
                byType[type].push(sub);
              });
              
              html += `<div class="group-header date-header"><i class="fas fa-calendar me-2"></i>${dateKey}</div>`;
              
              for (const [typeKey, typeSubs] of Object.entries(byType)) {
                const typeName = getFormTypeName(typeKey);
                html += `<div class="group-header type-subheader"><i class="fas fa-tag me-2"></i>${typeName} (${typeSubs.length})</div>`;
                html += typeSubs.map(sub => renderSubmissionCard(sub)).join('');
              }
            } else {
              html += `<div class="group-header date-header"><i class="fas fa-calendar me-2"></i>${dateKey} (${dateSubs.length})</div>`;
              html += dateSubs.map(sub => renderSubmissionCard(sub)).join('');
            }
          }
        } else if (groupBy === 'type') {
          // Group by type only
          const byType = {};
          submissions.forEach(sub => {
            const type = getFormType(sub);
            if (!byType[type]) byType[type] = [];
            byType[type].push(sub);
          });
          
          for (const [typeKey, typeSubs] of Object.entries(byType)) {
            const typeName = getFormTypeName(typeKey);
            html += `<div class="group-header type-header"><i class="fas fa-tag me-2"></i>${typeName} (${typeSubs.length})</div>`;
            html += typeSubs.map(sub => renderSubmissionCard(sub)).join('');
          }
        }
        
        return html;
      }

      // Determine form type from submission data
      function getFormType(sub) {
        // If form_type is explicitly set, use it
        if (sub.form_type) return sub.form_type;
        
        // Try to infer from form_name
        const formName = (sub.form_name || '').toLowerCase();
        const formId = (sub.form_id || '').toLowerCase();
        
        if (formName.includes('career') || formName.includes('job') || formName.includes('employment')) {
          return 'careers';
        }
        if (formName.includes('appointment') || formName.includes('schedule')) {
          return 'appointment';
        }
        if (formName.includes('self-check') || formName.includes('self check') || formName.includes('inspection')) {
          return 'self_check';
        }
        if (formName.includes('quote') || formName.includes('estimate')) {
          return 'quote';
        }
        if (formName.includes('contact')) {
          return 'contact';
        }
        
        // Check form_id patterns
        if (formId.includes('career') || formId.includes('job')) {
          return 'careers';
        }
        if (formId.includes('appointment') || formId.includes('schedule')) {
          return 'appointment';
        }
        if (formId.includes('contact')) {
          return 'contact';
        }
        
        // Check fields for clues - wpforms uses bracket notation
        const allFields = Object.keys(sub).join(' ').toLowerCase();
        
        if (allFields.includes('resume') || allFields.includes('position') || allFields.includes('job')) {
          return 'careers';
        }
        if (allFields.includes('appointment') || allFields.includes('schedule')) {
          return 'appointment';
        }
        
        // Default to contact
        return 'contact';
      }

      // Get readable name for form type
      function getFormTypeName(type) {
        const typeNames = {
          'contact': 'Contact Forms',
          'appointment': 'Appointments',
          'appointment_only': 'Appointment Requests',
          'self_check': 'Vehicle Self-Check',
          'lead_capture_start': 'Lead Captures',
          'careers': 'Career Applications',
          'quote': 'Quote Requests',
          'other': 'Other'
        };
        return typeNames[type] || type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }

      // Render individual submission card
      function renderSubmissionCard(sub) {
        const date = getSubmissionDate(sub);
        const dateStr = date ? date.toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        }) : 'Unknown date';

        const formType = getFormType(sub);
        const typeClass = formType;
        const typeName = sub.form_name || getFormTypeName(formType);
        
        // Handle various field name formats (wpforms uses bracket notation)
        const firstName = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || '';
        const lastName = sub.last_name || sub['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName || 'Unknown');
        
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';
        const message = sub.message || sub.comments || sub['wpforms[fields][5]'] || sub['wpforms[fields][6]'] || '';
        const vehicle = sub.vehicle || sub['wpforms[fields][7]'] || '';
        
        return `
          <div class="submission-card ${sub.read ? 'read' : 'unread'}" data-id="${sub.id}">
            <div class="submission-header">
              <div>
                <span class="submission-type ${typeClass}">${typeName}</span>
                <h5 style="margin: 8px 0 0; font-size: 18px;">${escapeHtml(name)}</h5>
              </div>
              <div class="submission-meta">
                ${dateStr}
                ${!sub.read ? '<span class="badge bg-danger ms-2">NEW</span>' : ''}
              </div>
            </div>
            
            <div class="submission-contact">
              ${email ? `
                <div class="submission-contact-item">
                  <i class="fas fa-envelope"></i>
                  <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>
                </div>
              ` : ''}
              ${phone ? `
                <div class="submission-contact-item">
                  <i class="fas fa-phone"></i>
                  <a href="tel:${escapeHtml(phone)}">${escapeHtml(phone)}</a>
                </div>
              ` : ''}
              ${vehicle ? `
                <div class="submission-contact-item">
                  <i class="fas fa-car"></i>
                  <span>${escapeHtml(vehicle)}</span>
                </div>
              ` : ''}
            </div>
            
            ${message ? `<div class="submission-message">${escapeHtml(message.length > 200 ? message.substring(0, 200) + '...' : message)}</div>` : ''}
            
            ${sub.form_type === 'self_check' && sub.items ? renderInspectionPreview(sub) : ''}
            
            <div class="submission-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="quickReply('${sub.id}')">
                <i class="fas fa-reply me-1"></i>Quick Reply
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('${sub.id}')">
                <i class="fas fa-eye me-1"></i>View Details
              </button>
              ${sub.form_type === 'self_check' && sub.items ? `
                <button class="btn btn-sm btn-outline-info" onclick="viewInspectionResults('${sub.id}')">
                  <i class="fas fa-clipboard-check me-1"></i>View Inspection
                </button>
              ` : ''}
              ${!sub.read ? `
                <button class="btn btn-sm btn-outline-success" onclick="markAsRead('${sub.id}')">
                  <i class="fas fa-check me-1"></i>Mark Read
                </button>
              ` : `
                <button class="btn btn-sm btn-outline-warning" onclick="markAsUnread('${sub.id}')">
                  <i class="fas fa-undo me-1"></i>Mark Unread
                </button>
              `}
              <button class="btn btn-sm btn-outline-danger" onclick="deleteSubmission('${sub.id}')">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
        `;
      }

      // Mark as read
      function markAsRead(id) {
        db.collection('form_submissions').doc(id).update({ read: true });
      }

      // Mark as unread  
      function markAsUnread(id) {
        db.collection('form_submissions').doc(id).update({ read: false });
      }

      // Delete submission
      function deleteSubmission(id) {
        if (confirm('Are you sure you want to delete this submission?')) {
          db.collection('form_submissions').doc(id).delete();
        }
      }

      // View full details
      function viewDetails(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub) return;

        // Mark as read
        markAsRead(id);

        const content = document.getElementById('details-content');
        content.innerHTML = `
          <table class="table table-bordered">
            <tbody>
              ${Object.entries(sub).map(([key, value]) => {
                if (key === 'id') return '';
                let displayValue = value;
                if (typeof value === 'object') {
                  displayValue = '<pre style="margin:0;font-size:12px;white-space:pre-wrap;">' + JSON.stringify(value, null, 2) + '</pre>';
                }
                return `
                  <tr>
                    <th style="width:200px;background:#f9f9f9;">${escapeHtml(key)}</th>
                    <td>${displayValue}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

        new bootstrap.Modal(document.getElementById('viewDetailsModal')).show();
      }

      // Quick reply
      function quickReply(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub) return;

        currentReplyData = sub;
        
        // Handle various field name formats (wpforms uses bracket notation)
        const firstName = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || '';
        const lastName = sub.last_name || sub['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName || 'Customer');
        
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';

        document.getElementById('reply-to').value = `${name} - ${email || phone}`;
        document.getElementById('reply-message').value = '';

        // Set up email link
        const emailBtn = document.getElementById('send-email-btn');
        emailBtn.onclick = () => {
          const message = encodeURIComponent(document.getElementById('reply-message').value);
          const subject = encodeURIComponent("Re: Your inquiry at Quality Lube Express");
          window.location.href = `mailto:${email}?subject=${subject}&body=${message}`;
        };

        // Set up SMS link
        const smsBtn = document.getElementById('send-sms-btn');
        smsBtn.onclick = () => {
          const message = encodeURIComponent(document.getElementById('reply-message').value);
          const cleanPhone = phone.replace(/\D/g, '');
          window.location.href = `sms:${cleanPhone}?body=${message}`;
        };

        new bootstrap.Modal(document.getElementById('quickReplyModal')).show();
      }

      // Template messages
      function useTemplate(type) {
        // Handle various field name formats for name
        const firstName = currentReplyData?.name || currentReplyData?.first_name || currentReplyData?.['wpforms[fields][1][first]'] || '';
        const lastName = currentReplyData?.last_name || currentReplyData?.['wpforms[fields][1][last]'] || '';
        const name = firstName && lastName ? `${firstName}` : (firstName || 'there');
        
        const templates = {
          appointment_confirm: `Hi ${name},\n\nThank you for scheduling an appointment with Quality Lube Express!\n\nWe've received your request and will contact you shortly to confirm the date and time.\n\nIf you have any questions, feel free to call us at (940) 566-5169.\n\nThank you,\nQuality Lube Express`,
          callback: `Hi ${name},\n\nThank you for reaching out to Quality Lube Express!\n\nWe've received your message and will give you a call back shortly.\n\nIf this is urgent, please call us directly at (940) 566-5169.\n\nThank you,\nQuality Lube Express`,
          quote: `Hi ${name},\n\nThank you for your inquiry at Quality Lube Express!\n\nBased on your request, here's what we can offer:\n\n[Quote details here]\n\nPlease let us know if you have any questions or would like to schedule an appointment.\n\nThank you,\nQuality Lube Express`,
          thank_you: `Hi ${name},\n\nThank you for choosing Quality Lube Express!\n\nWe appreciate your business and look forward to serving you again.\n\nIf you have any questions or need anything else, don't hesitate to reach out.\n\nThank you,\nQuality Lube Express`
        };
        
        document.getElementById('reply-message').value = templates[type] || '';
      }

      // Filter event listeners
      ['filter-type', 'filter-status', 'filter-date', 'filter-group'].forEach(id => {
        document.getElementById(id).addEventListener('change', renderSubmissions);
      });
      document.getElementById('filter-search').addEventListener('input', debounce(renderSubmissions, 300));

      // Clear filters
      function clearFilters() {
        document.getElementById('filter-type').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-group').value = '';
        document.getElementById('filter-search').value = '';
        renderSubmissions();
      }

      // Export to CSV
      function exportSubmissions() {
        const headers = ['Date', 'Type', 'Name', 'Email', 'Phone', 'Vehicle', 'Message', 'Read'];
        const rows = allSubmissions.map(sub => [
          sub.timestamp || '',
          sub.form_type || '',
          sub.name || sub.first_name || '',
          sub.email || '',
          sub.phone || '',
          sub.vehicle || '',
          (sub.message || sub.comments || '').replace(/[\n\r]/g, ' '),
          sub.read ? 'Yes' : 'No'
        ]);

        let csv = headers.join(',') + '\n';
        rows.forEach(row => {
          csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `form-submissions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      }

      // ==================== PRICING MANAGEMENT ====================

      // Load Services
      function loadServices() {
        document.getElementById('loading-spinner').style.display = 'block';
        const tbody = document.getElementById('services-table-body');
        tbody.innerHTML = '';

        db.collection('pricing_services')
          .get()
          .then((querySnapshot) => {
            document.getElementById('loading-spinner').style.display = 'none';
            allServices = [];

            if (querySnapshot.empty) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No services found. Click "Reset Data & Imports" to import defaults.</td></tr>';
              return;
            }

            querySnapshot.forEach((doc) => {
              allServices.push({ id: doc.id, ...doc.data() });
            });

            renderServicesTable(allServices);
          })
          .catch((error) => {
            console.error('Error getting documents: ', error);
            document.getElementById('loading-spinner').innerHTML = '<span class="text-danger">Error loading data.</span>';
          });
      }

      function renderServicesTable(services) {
        const tbody = document.getElementById('services-table-body');
        tbody.innerHTML = '';

        services.sort((a, b) => a.name.localeCompare(b.name));

        services.forEach((data) => {
          const row = `
            <tr>
              <td class="fw-bold">${data.name}</td>
              <td>${data.price}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editService('${data.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteService('${data.id}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // Save Service
      document.getElementById('save-service-btn').addEventListener('click', () => {
        const id = document.getElementById('service-id').value;
        const name = document.getElementById('service-name').value;
        const price = document.getElementById('service-price').value;

        const data = { name, price };

        if (id) {
          db.collection('pricing_services').doc(id).update(data).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
            loadServices();
          });
        } else {
          db.collection('pricing_services').add(data).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('addServiceModal')).hide();
            loadServices();
          });
        }
      });

      // Delete Service
      window.deleteService = (id) => {
        if (confirm('Are you sure you want to delete this service?')) {
          db.collection('pricing_services').doc(id).delete().then(() => loadServices());
        }
      };

      // Edit Service
      window.editService = (id) => {
        const service = allServices.find((s) => s.id === id);
        if (service) {
          document.getElementById('service-id').value = id;
          document.getElementById('service-name').value = service.name;
          document.getElementById('service-price').value = service.price;
          new bootstrap.Modal(document.getElementById('addServiceModal')).show();
        }
      };

      // Reset to Defaults
      window.resetToDefaults = () => {
        if (!confirm('DANGER: This will delete ALL Services from the Database.\nThe website will revert to its original static HTML styling.\nAre you sure?')) return;

        document.getElementById('loading-spinner').style.display = 'block';

        db.collection('pricing_services').get().then((snapshot) => {
          const batch = db.batch();
          snapshot.docs.forEach((doc) => batch.delete(doc.ref));
          return batch.commit();
        }).then(() => {
          alert('Database Cleared. Website will now use default static HTML.');
          loadServices();
        }).catch((err) => {
          alert('Error: ' + err.message);
          document.getElementById('loading-spinner').style.display = 'none';
        });
      };

      // Re-Import Defaults
      window.reimportDefaults = () => {
        if (!confirm('This will DELETE all current data and re-import defaults.\nContinue?')) return;

        document.getElementById('loading-spinner').style.display = 'block';

        db.collection('pricing_services').get().then((snapshot) => {
          const batch = db.batch();
          snapshot.docs.forEach((doc) => batch.delete(doc.ref));
          return batch.commit();
        }).then(() => importServices(true));
      };

      // Import Services
      async function importServices(auto = false) {
        try {
          const defaultServices = [
            { name: 'Mobil 1', price: '$96.99 10k/Mi', category: 'Oil' },
            { name: 'MOBILE SYNTHETIC', price: '$74.99 7k/Mi', category: 'Oil' },
            { name: 'DELVAC 1300', price: '$109.99 7K/Mi', category: 'Oil' },
            { name: 'DELVAC 15w40', price: '$149.99 12K/Mi', category: 'Oil' },
            { name: 'DELVAC 1 5w40', price: '$149.99 12K/Mi', category: 'Oil' },
            { name: 'WIPER BLADES', price: '12.99/PC', category: 'Oil' },
            { name: 'Cars/SUV', price: '$178.48*', category: 'Brakes' },
            { name: 'Heavy Duty', price: '$232.52*', category: 'Brakes' },
            { name: 'TIRE REPAIR', price: '$25.99', category: 'Tires' },
            { name: 'TIRE ROTATION', price: '$19.99', category: 'Tires' },
            { name: 'ROTATE & BALANCE', price: '$43.99', category: 'Tires' },
            { name: '33+ TIRE ROTATION', price: '$34.99', category: 'Tires' },
            { name: '33+ ROTATE & BALANCE', price: '$83.99', category: 'Tires' },
            { name: 'MOUNT/BALANCE', price: '$24.99/TIRE', category: 'Tires' },
            { name: 'OVERSIZED', price: '$34.99/Tire', category: 'Tires' },
            { name: 'REVERSED MOUNT', price: '+15%', category: 'Tires' },
            { name: 'TPMS SENSOR', price: '$42.99', category: 'Tires' },
          ];

          const batch = db.batch();
          defaultServices.forEach((service) => {
            const newRef = db.collection('pricing_services').doc();
            batch.set(newRef, service);
          });

          await batch.commit();
          alert(`Successfully added ${defaultServices.length} default services!`);
          loadServices();
        } catch (e) {
          console.error('Error importing:', e);
          alert('Error importing: ' + e.message);
        }
      }

      // ==================== UTILITY FUNCTIONS ====================

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // ==================== INSPECTION RESULTS FUNCTIONS ====================

      // Inspection item labels mapping (from the self-check form)
      const inspectionLabels = {
        'dashboard_warning_lights': 'Dashboard Warning Lights',
        'battery_corrosion': 'Battery Condition',
        'coolant_low': 'Coolant Level',
        'tire_wear': 'Tire Condition',
        'tire_pressure': 'Tire Pressure',
        'brake_pads': 'Brake Pads',
        'brake_fluid': 'Brake Fluid',
        'wiper_blades': 'Wiper Blades',
        'headlights': 'Headlights',
        'taillights': 'Taillights',
        'turn_signals': 'Turn Signals',
        'oil_level': 'Oil Level',
        'transmission_fluid': 'Transmission Fluid',
        'power_steering': 'Power Steering Fluid',
        'air_filter': 'Air Filter',
        'cabin_filter': 'Cabin Air Filter',
        'belts': 'Belts',
        'hoses': 'Hoses',
        'exhaust': 'Exhaust System',
        'suspension': 'Suspension',
        'steering': 'Steering',
        'fluid_leak': 'Fluid Leaks',
        'unusual_sounds': 'Unusual Sounds',
        'vibration': 'Vibrations'
      };

      // Render inspection preview (condensed view for submission card)
      function renderInspectionPreview(sub) {
        if (!sub.items || typeof sub.items !== 'object') return '';
        
        const items = sub.items;
        const itemKeys = Object.keys(items);
        if (itemKeys.length === 0) return '';
        
        // Count by status
        let goodCount = 0, warningCount = 0, badCount = 0;
        itemKeys.forEach(key => {
          const state = items[key]?.state;
          if (state === 'good') goodCount++;
          else if (state === 'warning') warningCount++;
          else if (state === 'bad') badCount++;
        });
        
        // Get items with issues (warning or bad)
        const issueItems = itemKeys.filter(key => 
          items[key]?.state === 'warning' || items[key]?.state === 'bad'
        ).slice(0, 3);
        
        let html = `
          <div class="inspection-results">
            <div class="inspection-results-title">
              <i class="fas fa-clipboard-check me-1"></i>Self-Inspection Summary
            </div>
        `;
        
        if (issueItems.length > 0) {
          html += `<div style="font-size:13px;color:#495057;margin-bottom:8px;">Issues flagged:</div>`;
          issueItems.forEach(key => {
            const item = items[key];
            const label = inspectionLabels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const iconClass = item.state === 'bad' ? 'bad' : 'warning';
            const icon = item.state === 'bad' ? 'fa-times-circle' : 'fa-exclamation-triangle';
            html += `
              <div class="inspection-item">
                <div class="inspection-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                <div class="inspection-label">${escapeHtml(label)}</div>
              </div>
            `;
          });
          if (itemKeys.filter(key => items[key]?.state === 'warning' || items[key]?.state === 'bad').length > 3) {
            html += `<div style="font-size:12px;color:#6c757d;margin-top:5px;">+ more issues found...</div>`;
          }
        }
        
        html += `
          <div class="inspection-summary">
            <span class="inspection-summary-item">
              <i class="fas fa-check-circle text-success"></i> ${goodCount} Good
            </span>
            <span class="inspection-summary-item">
              <i class="fas fa-exclamation-triangle text-warning"></i> ${warningCount} Warning
            </span>
            <span class="inspection-summary-item">
              <i class="fas fa-times-circle text-danger"></i> ${badCount} Needs Attention
            </span>
          </div>
        </div>`;
        
        return html;
      }

      // View full inspection results
      function viewInspectionResults(id) {
        const sub = allSubmissions.find(s => s.id === id);
        if (!sub || !sub.items) return;

        // Mark as read
        markAsRead(id);

        const content = document.getElementById('inspection-results-content');
        const items = sub.items;
        const itemKeys = Object.keys(items);
        
        // Customer info - handle wpforms bracket notation
        const name = sub.name || sub.first_name || sub['wpforms[fields][1][first]'] || 'Customer';
        const email = sub.email || sub['wpforms[fields][4]'] || sub['wpforms[fields][2]'] || '';
        const phone = sub.phone || sub['wpforms[fields][3]'] || '';
        const vehicle = sub.vehicle || sub['wpforms[fields][7]'] || '';
        const subDate = getSubmissionDate(sub);
        const date = subDate ? subDate.toLocaleString() : 'Unknown';
        
        let html = `
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Customer Information</h6>
              <p class="mb-1"><strong>Name:</strong> ${escapeHtml(name)}</p>
              ${email ? `<p class="mb-1"><strong>Email:</strong> <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a></p>` : ''}
              ${phone ? `<p class="mb-1"><strong>Phone:</strong> <a href="tel:${escapeHtml(phone)}">${escapeHtml(phone)}</a></p>` : ''}
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Vehicle & Date</h6>
              ${vehicle ? `<p class="mb-1"><strong>Vehicle:</strong> ${escapeHtml(vehicle)}</p>` : ''}
              <p class="mb-1"><strong>Submitted:</strong> ${escapeHtml(date)}</p>
            </div>
          </div>
          
          <hr>
          
          <h6 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Inspection Results</h6>
          <div class="row">
        `;
        
        // Group items by status
        const goodItems = [], warningItems = [], badItems = [];
        itemKeys.forEach(key => {
          const item = items[key];
          if (item.state === 'good') goodItems.push({ key, ...item });
          else if (item.state === 'warning') warningItems.push({ key, ...item });
          else if (item.state === 'bad') badItems.push({ key, ...item });
        });
        
        // Render issues first (bad + warning)
        if (badItems.length > 0 || warningItems.length > 0) {
          html += `<div class="col-12 mb-3">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>Items Needing Attention (${badItems.length + warningItems.length})
              </div>
              <div class="card-body">`;
          
          [...badItems, ...warningItems].forEach(item => {
            const label = inspectionLabels[item.key] || item.key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const iconClass = item.state === 'bad' ? 'text-danger' : 'text-warning';
            const icon = item.state === 'bad' ? 'fa-times-circle' : 'fa-exclamation-triangle';
            
            html += `
              <div class="mb-3 pb-3 border-bottom">
                <div class="d-flex align-items-center">
                  <i class="fas ${icon} ${iconClass} me-2" style="font-size:18px;"></i>
                  <strong>${escapeHtml(label)}</strong>
                  <span class="badge ${item.state === 'bad' ? 'bg-danger' : 'bg-warning text-dark'} ms-2">
                    ${item.state === 'bad' ? 'Needs Attention' : 'Warning'}
                  </span>
                </div>
                ${item.notes ? `<p class="mb-1 mt-2 text-muted"><i class="fas fa-sticky-note me-1"></i>${escapeHtml(item.notes)}</p>` : ''}
                ${renderExtraData(item.extraData)}
              </div>
            `;
          });
          
          html += `</div></div></div>`;
        }
        
        // Render good items
        if (goodItems.length > 0) {
          html += `<div class="col-12">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>Items in Good Condition (${goodItems.length})
              </div>
              <div class="card-body">
                <div class="row">`;
          
          goodItems.forEach(item => {
            const label = inspectionLabels[item.key] || item.key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `
              <div class="col-md-4 col-sm-6 mb-2">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle text-success me-2"></i>
                  <span>${escapeHtml(label)}</span>
                </div>
                ${item.notes ? `<small class="text-muted ms-4">${escapeHtml(item.notes)}</small>` : ''}
              </div>
            `;
          });
          
          html += `</div></div></div></div>`;
        }
        
        html += `</div>`;
        
        // Appointment request info
        if (sub.appointment_request) {
          html += `
            <hr>
            <div class="alert alert-info">
              <i class="fas fa-calendar-check me-2"></i>
              <strong>Appointment Requested:</strong> Customer wants to schedule a professional inspection.
              ${sub.appointment_comments ? `<br><small>${escapeHtml(sub.appointment_comments)}</small>` : ''}
            </div>
          `;
        }

        content.innerHTML = html;
        new bootstrap.Modal(document.getElementById('inspectionResultsModal')).show();
      }

      // Render extra data from inspection items
      function renderExtraData(extraData) {
        if (!extraData || typeof extraData !== 'object') return '';
        
        const entries = Object.entries(extraData).filter(([k, v]) => v && v !== 'I am unsure');
        if (entries.length === 0) return '';
        
        let html = '<div class="mt-2 ms-4 p-2 bg-light rounded">';
        entries.forEach(([key, value]) => {
          // Format key nicely
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          
          if (Array.isArray(value)) {
            // Handle arrays (like selected warning lights)
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong></small>`;
            if (value.length > 0) {
              html += '<ul class="mb-0 ms-3">';
              value.forEach(v => {
                if (typeof v === 'object' && v.name) {
                  html += `<li><small>${escapeHtml(v.name)}</small></li>`;
                } else {
                  html += `<li><small>${escapeHtml(String(v))}</small></li>`;
                }
              });
              html += '</ul>';
            }
            html += '</div>';
          } else if (typeof value === 'object') {
            // Handle nested objects
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong> ${escapeHtml(JSON.stringify(value))}</small></div>`;
          } else {
            html += `<div class="mb-1"><small><strong>${escapeHtml(label)}:</strong> ${escapeHtml(String(value))}</small></div>`;
          }
        });
        html += '</div>';
        
        return html;
      }

      // Print inspection results
      function printInspectionResults() {
        const content = document.getElementById('inspection-results-content').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Vehicle Inspection Report - Quality Lube Express</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
              body { padding: 20px; font-size: 14px; }
              @media print { .no-print { display: none; } }
            </style>
          </head>
          <body>
            <div class="text-center mb-4">
              <h3>Quality Lube Express</h3>
              <p class="text-muted">Vehicle Self-Inspection Report</p>
            </div>
            ${content}
            <script>window.print(); setTimeout(() => window.close(), 500);<\/script>
          </body>
          </html>
        `);
      }
    </script>
  </body>
</html>
